{% extends 'turnero/base.html' %}

{% block title %}Paso 2: Datos del Vehículo - Turnos RTV{% endblock %}

{% block extra_css %}
<style>
    .cliente-info {
        background: #f8f9fa;
        border-left: 4px solid var(--primary-color);
        padding: 1rem 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }

    .cliente-info strong {
        color: var(--primary-color);
    }

    .search-section {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }

    .search-title {
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
    }

    .divider {
        text-align: center;
        margin: 2rem 0;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .divider::before {
        content: '';
        flex: 1;
        height: 2px;
        background: linear-gradient(to right, transparent, #e9ecef);
        margin-right: 1rem;
    }

    .divider::after {
        content: '';
        flex: 1;
        height: 2px;
        background: linear-gradient(to left, transparent, #e9ecef);
        margin-left: 1rem;
    }

    .divider-text {
        color: #6c757d;
        font-weight: 600;
        white-space: nowrap;
        padding: 0 0.5rem;
    }

    .form-section {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 10px;
        margin-top: 1.5rem;
    }

    .result-info {
        background: #f0f4f8;
        border-left: 4px solid var(--primary-color);
        padding: 1rem 1.5rem;
        border-radius: 10px;
        margin-top: 1rem;
        display: none;
    }

    .result-info.show {
        display: block;
        animation: fadeInUp 0.5s ease;
    }

    .result-info h5 {
        color: var(--primary-color);
        font-weight: 700;
    }

    .result-info p {
        color: #333;
        margin: 0.25rem 0;
    }

    .input-icon {
        position: relative;
    }

    .input-icon i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary-color);
    }

    .input-icon input {
        padding-left: 3rem;
    }

    .patente-preview {
        background: white;
        border: 3px solid #333;
        border-radius: 5px;
        padding: 1rem 2rem;
        font-family: 'Courier New', monospace;
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        letter-spacing: 0.3rem;
        margin: 1rem 0;
        text-transform: uppercase;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .tipo-vehiculo-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.2rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        user-select: none;
    }

    .tipo-vehiculo-card::before {
        content: '\f14a';
        font-family: 'Font Awesome 6 Free';
        font-weight: 400;
        position: absolute;
        right: 1rem;
        top: 1rem;
        font-size: 1.5rem;
        color: #e9ecef;
        transition: all 0.3s ease;
    }

    .tipo-vehiculo-card:hover {
        border-color: var(--primary-color);
        transform: translateX(5px);
        box-shadow: var(--card-shadow);
    }

    .tipo-vehiculo-card:hover::before {
        color: var(--primary-color);
    }

    .tipo-vehiculo-card.selected {
        border-color: var(--primary-color);
        border-width: 3px;
        background: #f0f4f8;
        box-shadow: 0 4px 12px rgba(19, 48, 77, 0.15);
    }

    .tipo-vehiculo-card.selected::before {
        content: '\f058';
        font-weight: 900;
        color: var(--primary-color);
        animation: checkBounce 0.5s ease;
    }

    @keyframes checkBounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }

    .precio-badge {
        background: #28a745;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1rem;
        min-width: 120px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .duracion-badge {
        background: var(--primary-color);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    /* Responsive - Tablets */
    @media (max-width: 991px) {
        .search-section {
            padding: 1.5rem;
        }

        .form-section {
            padding: 1.5rem;
        }

        .patente-preview {
            font-size: 1.75rem;
            padding: 0.75rem 1.5rem;
        }

        .tipo-vehiculo-card {
            padding: 1rem;
        }
    }

    /* Responsive - Móviles */
    @media (max-width: 767px) {
        .search-section {
            padding: 1.25rem;
        }

        .form-section {
            padding: 1.25rem;
        }

        .patente-preview {
            font-size: 1.5rem;
            padding: 0.75rem 1rem;
            letter-spacing: 0.2rem;
        }

        .tipo-vehiculo-card {
            padding: 1rem;
        }

        .tipo-vehiculo-card h5 {
            font-size: 0.95rem;
        }

        .tipo-vehiculo-card p {
            font-size: 0.85rem;
        }

        .tipo-vehiculo-card .d-flex {
            flex-direction: column;
        }

        .tipo-vehiculo-card .text-end {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            margin-left: 0 !important;
        }

        .precio-badge {
            font-size: 0.85rem;
            padding: 0.35rem 0.6rem;
            min-width: 100px;
        }

        .duracion-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
        }
    }

    /* Responsive - Móviles pequeños */
    @media (max-width: 576px) {
        .search-section {
            padding: 1rem;
        }

        .form-section {
            padding: 1rem;
        }

        .search-title {
            font-size: 1rem;
        }

        .patente-preview {
            font-size: 1.25rem;
            padding: 0.5rem 0.75rem;
        }

        .tipo-vehiculo-card::before {
            font-size: 1.2rem;
            right: 0.75rem;
            top: 0.75rem;
        }

        .divider-text {
            font-size: 0.8rem;
        }
    }

    /* Estilos para modal de turno pendiente */
    .swal2-popup-custom {
        border-radius: 15px !important;
    }

    .swal2-popup-custom .swal2-footer {
        border-top: none !important;
        padding-top: 0 !important;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Navegacion volver -->
<a href="{% url 'turnero:step1_cliente' %}" class="nav-volver" data-aos="fade-right">
    <i class="fas fa-arrow-left"></i>
    <span>Volver al paso anterior</span>
</a>

<!-- Info del cliente -->
<div class="cliente-info" data-aos="fade-down">
    <i class="fas fa-user-check"></i>
    <span><strong>Cliente:</strong> {{ cliente.nombre }} {{ cliente.apellido }} - <strong>DNI:</strong> {{ cliente.dni }}</span>
</div>

<div class="card-custom" data-aos="fade-up">
    <div class="card-header-custom">
        <h3>
            <i class="fas fa-car"></i> Datos del Vehiculo
        </h3>
{% comment %}         <p class="mb-0 mt-2">
            Busca tu vehiculo por dominio o registra uno nuevo
        </p> {% endcomment %}
    </div>
            <div class="card-body-custom">
                {% if error %}
                <div class="alert alert-error-custom" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> {{ error }}
                </div>
                {% endif %}

                <!-- Búsqueda por dominio -->
                <div class="search-section">
                    <h4 class="search-title mb-3">
                        <i class="fas fa-search me-2"></i>Buscá tu vehículo
                    </h4>
                    <div class="row g-3">
                        <div class="col-md-8">
                            <div class="input-icon">
                                <i class="fas fa-car"></i>
                                <input type="text" class="form-control text-uppercase" id="dominio_busqueda_input"
                                       placeholder="ABC123 o AB123CD" maxlength="7">
                            </div>
                            <div class="patente-preview" id="patente_preview"></div>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary-custom btn-search w-100" id="btn_buscar_vehiculo">
                                <i class="fas fa-search me-2"></i>Buscar
                            </button>
                        </div>
                    </div>
                    <div class="result-info" id="result_vehiculo">
                        <h5 class="mb-3"><i class="fas fa-check-circle me-2"></i>Vehículo encontrado</h5>
                        <p class="mb-2" id="vehiculo_dominio"></p>
                        <p class="mb-3" id="vehiculo_tipo"></p>
                        <button type="button" class="btn btn-success mt-2" id="btn_usar_vehiculo">
                            <i class="fas fa-arrow-right me-2"></i>Continuar con este vehículo
                        </button>
                    </div>
                </div>

                <div class="divider my-4">
                    <span class="divider-text">O REGISTRÁ UN VEHÍCULO NUEVO</span>
                </div>

                <!-- Formulario de creación -->
                <form method="post" id="form_vehiculo">
                    {% csrf_token %}
                    <input type="hidden" name="dominio_busqueda" id="dominio_busqueda_field">

                    <div class="form-section" id="form_datos_vehiculo" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="{{ form.dominio.id_for_label }}" class="form-label">
                                    <i class="fas fa-car me-2"></i>Dominio / Patente *
                                </label>
                                <input type="text" class="form-control text-uppercase"
                                       id="{{ form.dominio.id_for_label }}"
                                       name="dominio" maxlength="7"
                                       placeholder="ABC123 o AB123CD" required>
                                <small class="text-muted d-block mt-1">Formatos: ABC123 (vieja) o AB123CD (nueva)</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-gas-pump me-2"></i>¿Tiene GNC?
                                </label>
                                <div class="form-check form-switch mt-3">
                                    <input class="form-check-input" type="checkbox"
                                           id="{{ form.tiene_gnc.id_for_label }}"
                                           name="tiene_gnc">
                                    <label class="form-check-label ms-2" for="{{ form.tiene_gnc.id_for_label }}">
                                        Sí, el vehículo tiene instalación de GNC
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN OCULTA: Tipo de Trámite RTO (deshabilitada temporalmente por pedido del cliente) -->
                        <!-- Para reactivar: quitar la clase "d-none" del div contenedor -->
                        <div class="mb-4 mt-4 d-none" id="seccion_tipo_tramite">
                            <label class="form-label">
                                <i class="fas fa-clipboard-list me-2"></i>Tipo de Trámite RTO *
                            </label>
                            <small class="text-muted d-block mb-3">
                                <i class="fas fa-hand-pointer me-1"></i>Hacé clic en una opción para seleccionarla
                            </small>

                            <!-- Cuadro informativo de tarifas -->
                            <div class="alert alert-info mb-4" style="background: #f8f9fa; border-left: 4px solid var(--primary-color); border-radius: 10px;">
                                <h6 class="mb-3" style="color: var(--primary-color); font-weight: 700;">
                                    <i class="fas fa-info-circle me-2"></i>Tipos de Tarifas
                                </h6>
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-start">
                                            <span class="badge me-2" style="background: var(--primary-color); padding: 0.4rem 0.6rem; font-size: 0.75rem;">PROVINCIAL</span>
                                            <small style="color: #333; line-height: 1.5;">
                                                Para residentes de la provincia de Jujuy
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-start">
                                            <span class="badge me-2" style="background: #28a745; padding: 0.4rem 0.6rem; font-size: 0.75rem;">NACIONAL</span>
                                            <small style="color: #333; line-height: 1.5;">
                                                Para residentes de otras provincias
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-start">
                                            <span class="badge me-2" style="background: #6c757d; color: #fff; padding: 0.4rem 0.6rem; font-size: 0.75rem;">CAJUTAC</span>
                                            <small style="color: #333; line-height: 1.5;">
                                                Cámara Jujeña del Transporte Automotor de Cargas
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="tipos_vehiculo_container">
                                {% for tipo in form.tipo_vehiculo.field.queryset %}
                                <div class="tipo-vehiculo-card" data-tipo-id="{{ tipo.id }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h5 class="mb-2" style="color: var(--primary-color); font-weight: 600;">
                                                {{ tipo.codigo_tramite }} - {{ tipo.nombre }}
                                            </h5>
                                            <p class="mb-2 text-muted">{{ tipo.descripcion }}</p>
                                            <span class="duracion-badge">
                                                <i class="fas fa-clock me-1"></i>{{ tipo.duracion_minutos }} min
                                            </span>
                                        </div>
                                        <div class="text-end ms-3">
                                            {% if tipo.precio_provincial %}
                                            <div class="precio-badge mb-2" style="background: #007bff;">
                                                <small style="font-size: 0.75rem; opacity: 0.9;">Provincial</small><br>
                                                $ {{ tipo.precio_provincial|floatformat:0 }}
                                            </div>
                                            {% endif %}
                                            {% if tipo.precio_nacional %}
                                            <div class="precio-badge mb-2" style="background: #28a745;">
                                                <small style="font-size: 0.75rem; opacity: 0.9;">Nacional</small><br>
                                                $ {{ tipo.precio_nacional|floatformat:0 }}
                                            </div>
                                            {% endif %}
                                            {% if tipo.precio_cajutad %}
                                            <div class="precio-badge" style="background: #ffc107; color: #000;">
                                                <small style="font-size: 0.75rem; opacity: 0.9;">CAJUTAC</small><br>
                                                $ {{ tipo.precio_cajutad|floatformat:0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <!-- El campo hidden se mantiene para el backend -->
                        <input type="hidden" name="tipo_vehiculo" id="tipo_vehiculo_selected">

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary-custom btn-lg">
                                <i class="fas fa-arrow-right me-2"></i>Continuar al Paso 3
                            </button>
                        </div>
                    </div>

                    <div class="text-center mt-3" id="show_form_vehiculo_btn">
                        <button type="button" class="btn btn-secondary-custom" id="btn_mostrar_form_vehiculo">
                            <i class="fas fa-plus me-2"></i>Registrar nuevo vehículo
                        </button>
                    </div>
                </form>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
<script>
    // Variable para guardar datos del turno pendiente
    let turnoPendienteData = null;

    // Cleave.js para formatear patente
    const dominioSearchCleave = new Cleave('#dominio_busqueda_input', {
        uppercase: true,
        blocks: [7]
    });

    const dominioFormCleave = new Cleave('#{{ form.dominio.id_for_label }}', {
        uppercase: true,
        blocks: [7]
    });

    // Preview de patente mientras se escribe
    document.getElementById('dominio_busqueda_input').addEventListener('input', function(e) {
        const valor = e.target.value.toUpperCase();
        document.getElementById('patente_preview').textContent = valor || '---';
    });

    // Función para mostrar modal de turno pendiente
    function mostrarModalTurnoPendiente(turno) {
        turnoPendienteData = turno;

        const puedeReprogramar = turno.puede_reprogramar;
        const estadoBadge = turno.estado === 'Confirmado'
            ? '<span class="badge bg-success">Confirmado</span>'
            : '<span class="badge bg-warning text-dark">Pendiente</span>';

        let botonesHtml = '';
        if (puedeReprogramar) {
            botonesHtml = `
                <button type="button" class="btn btn-primary-custom" id="btnSolicitarReprogramacion">
                    <i class="fas fa-calendar-alt me-2"></i>Solicitar Reprogramación
                </button>
                <button type="button" class="btn btn-secondary-custom" onclick="Swal.close()">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            `;
        } else {
            botonesHtml = `
                <button type="button" class="btn btn-secondary-custom" onclick="Swal.close()">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            `;
        }

        Swal.fire({
            title: '<i class="fas fa-exclamation-triangle text-warning me-2"></i>Turno Pendiente',
            html: `
                <div class="text-start">
                    <p class="mb-3">Este vehículo ya tiene un turno programado:</p>

                    <div class="p-3 rounded" style="background: #f8f9fa; border-left: 4px solid var(--primary-color);">
                        <div class="mb-2">
                            <strong><i class="fas fa-ticket-alt me-2"></i>Código:</strong>
                            <span class="badge bg-dark">${turno.codigo}</span>
                        </div>
                        <div class="mb-2">
                            <strong><i class="fas fa-calendar me-2"></i>Fecha:</strong> ${turno.fecha}
                        </div>
                        <div class="mb-2">
                            <strong><i class="fas fa-clock me-2"></i>Hora:</strong> ${turno.hora} hs
                        </div>
                        <div class="mb-2">
                            <strong><i class="fas fa-building me-2"></i>Taller:</strong> ${turno.taller_nombre}
                        </div>
                        <div class="mb-2">
                            <strong><i class="fas fa-map-marker-alt me-2"></i>Dirección:</strong> ${turno.taller_direccion}
                        </div>
                        <div class="mb-2">
                            <strong><i class="fas fa-clipboard-list me-2"></i>Trámite:</strong> ${turno.tipo_tramite}
                        </div>
                        <div class="mb-2">
                            <strong><i class="fas fa-info-circle me-2"></i>Estado:</strong> ${estadoBadge}
                        </div>
                        <hr class="my-2">
                        <div class="mb-2">
                            <strong><i class="fas fa-user me-2"></i>Solicitado por:</strong> ${turno.cliente_nombre}
                        </div>
                        <div class="mb-0">
                            <strong><i class="fas fa-id-card me-2"></i>DNI:</strong> ${turno.cliente_dni}
                        </div>
                    </div>

                    ${puedeReprogramar ? `
                    <div class="alert alert-info mt-3 mb-0" style="font-size: 0.9rem;">
                        <i class="fas fa-info-circle me-2"></i>
                        Si necesitás cambiar la fecha u hora, podés solicitar una reprogramación.
                        Te enviaremos un email a <strong>${turno.cliente_email}</strong> con un enlace para elegir un nuevo horario.
                    </div>
                    ` : `
                    <div class="alert alert-warning mt-3 mb-0" style="font-size: 0.9rem;">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Este turno no puede ser reprogramado porque debe faltar al menos 24 horas para poder hacerlo.
                    </div>
                    `}
                </div>
            `,
            showConfirmButton: false,
            showCloseButton: true,
            width: '550px',
            customClass: {
                popup: 'swal2-popup-custom'
            },
            footer: `<div class="d-flex gap-2 justify-content-center w-100">${botonesHtml}</div>`,
            didOpen: () => {
                // Agregar evento al botón de reprogramación
                const btnReprogramar = document.getElementById('btnSolicitarReprogramacion');
                if (btnReprogramar) {
                    btnReprogramar.addEventListener('click', solicitarReprogramacion);
                }
            }
        });
    }

    // Función para solicitar reprogramación
    function solicitarReprogramacion() {
        if (!turnoPendienteData) return;

        Swal.fire({
            title: 'Solicitando reprogramación...',
            html: '<div class="loading-spinner mx-auto my-3"></div><p>Enviando email con enlace de reprogramación...</p>',
            allowOutsideClick: false,
            showConfirmButton: false
        });

        fetch(`/turnero/solicitar-reprogramacion/${turnoPendienteData.id}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Email Enviado!',
                    html: `
                        <p>${data.message}</p>
                        <p class="mt-3 text-muted" style="font-size: 0.9rem;">
                            <i class="fas fa-envelope me-2"></i>
                            Revisá tu casilla de correo: <strong>${turnoPendienteData.cliente_email}</strong>
                        </p>
                    `,
                    confirmButtonColor: '#13304D',
                    confirmButtonText: 'Entendido'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'No se pudo enviar el email de reprogramación.',
                    confirmButtonColor: '#13304D',
                    confirmButtonText: 'Cerrar'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo conectar con el servidor. Intentá nuevamente.',
                confirmButtonColor: '#13304D',
                confirmButtonText: 'Cerrar'
            });
        });
    }

    // Buscar vehículo por dominio
    document.getElementById('btn_buscar_vehiculo').addEventListener('click', function() {
        const dominio = document.getElementById('dominio_busqueda_input').value;

        if (!dominio || dominio.length < 6) {
            showWarning('Por favor, ingrese un dominio válido (6-7 caracteres)', 'Dominio Requerido');
            return;
        }

        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> Buscando...';

        fetch(`{% url 'turnero:buscar_vehiculo_ajax' %}?dominio=${dominio}`)
            .then(response => response.json())
            .then(data => {
                if (data.found) {
                    // Verificar si hay turno pendiente
                    if (data.turno_pendiente) {
                        // Mostrar modal de turno pendiente
                        mostrarModalTurnoPendiente(data.turno_pendiente);
                    } else {
                        // No hay turno pendiente, mostrar resultado normal
                        document.getElementById('vehiculo_dominio').textContent =
                            `Dominio: ${data.data.dominio}`;
                        document.getElementById('vehiculo_tipo').textContent =
                            `Tipo: ${data.data.tipo_vehiculo_nombre}`;
                        document.getElementById('result_vehiculo').classList.add('show');
                        document.getElementById('dominio_busqueda_field').value = dominio;

                        // Scroll hacia el resultado encontrado
                        setTimeout(() => {
                            document.getElementById('result_vehiculo').scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }, 100);
                    }
                } else {
                    document.getElementById('result_vehiculo').classList.remove('show');
                    mostrarFormularioVehiculo();
                    document.getElementById('{{ form.dominio.id_for_label }}').value = dominio;

                    // Mostrar mensaje y hacer scroll DESPUÉS de que se cierre
                    Swal.fire({
                        icon: 'info',
                        title: 'Vehículo No Encontrado',
                        text: 'No se encontró un vehículo con ese dominio. Podés registrarlo completando el formulario.',
                        confirmButtonColor: '#13304D',
                        confirmButtonText: 'Aceptar'
                    }).then(() => {
                        // Scroll hacia el formulario después de cerrar el modal
                        document.getElementById('form_datos_vehiculo').scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Ocurrió un error al buscar el vehículo. Intente nuevamente.', 'Error de Conexión');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> Buscar';
            });
    });

    // Continuar con vehículo encontrado
    document.getElementById('btn_usar_vehiculo').addEventListener('click', function() {
        document.getElementById('form_vehiculo').submit();
    });

    // Mostrar formulario
    function mostrarFormularioVehiculo() {
        document.getElementById('form_datos_vehiculo').style.display = 'block';
        document.getElementById('show_form_vehiculo_btn').style.display = 'none';
        AOS.refresh();
    }

    document.getElementById('btn_mostrar_form_vehiculo').addEventListener('click', mostrarFormularioVehiculo);

    // Selección de tipo de vehículo
    document.querySelectorAll('.tipo-vehiculo-card').forEach(card => {
        card.addEventListener('click', function() {
            // Remover selección anterior
            document.querySelectorAll('.tipo-vehiculo-card').forEach(c =>
                c.classList.remove('selected'));

            // Seleccionar este
            this.classList.add('selected');
            document.getElementById('tipo_vehiculo_selected').value =
                this.getAttribute('data-tipo-id');
        });
    });

    // Función para validar formato de dominio (patente)
    function validarFormatoDominio(dominio) {
        if (!dominio) return false;
        dominio = dominio.toUpperCase().trim();
        // Formato viejo: 3 letras + 3 números (ABC123)
        const formatoViejo = /^[A-Z]{3}[0-9]{3}$/;
        // Formato nuevo: 2 letras + 3 números + 2 letras (AB123CD)
        const formatoNuevo = /^[A-Z]{2}[0-9]{3}[A-Z]{2}$/;
        return formatoViejo.test(dominio) || formatoNuevo.test(dominio);
    }

    // Validación del formulario
    document.getElementById('form_vehiculo').addEventListener('submit', function(e) {
        // Solo validar si el formulario de datos está visible (nuevo vehículo)
        if (document.getElementById('form_datos_vehiculo').style.display !== 'none') {
            const dominio = document.getElementById('{{ form.dominio.id_for_label }}').value;

            // Validar formato de dominio
            if (!validarFormatoDominio(dominio)) {
                e.preventDefault();
                showError(
                    'El formato del dominio es inválido. Use el formato ABC123 (patente vieja) o AB123CD (patente nueva del Mercosur).',
                    'Formato de Dominio Inválido'
                );
                document.getElementById('{{ form.dominio.id_for_label }}').focus();
                return;
            }

            // NOTA: Validación de tipo_vehiculo removida - se auto-selecciona en el backend
        }
    });

    // Enter en búsqueda
    document.getElementById('dominio_busqueda_input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('btn_buscar_vehiculo').click();
        }
    });
</script>
{% endblock %}
