{% extends 'turnero/base.html' %}

{% block title %}Consultar Turno - Turnos RTV{% endblock %}

{% block extra_css %}
<style>
    /* ========== Expandir contenedor ========== */
    .content-wrapper {
        max-width: 1000px !important;
    }

    .main-content {
        justify-content: flex-start !important;
        padding-top: 2rem !important;
        background: #f1f5f9 !important;
    }

    /* ========== Hero Section ========== */
    .consultar-hero {
        background: linear-gradient(135deg, #13304D 0%, #1a4a6e 50%, #2d6a9f 100%);
        color: white;
        padding: 3rem 2.5rem;
        border-radius: 20px;
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .consultar-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
        border-radius: 50%;
    }

    .consultar-hero-icon {
        width: 70px;
        height: 70px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        font-size: 1.8rem;
    }

    .consultar-hero h2 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
    }

    .consultar-hero p {
        font-size: 1.05rem;
        opacity: 0.9;
        max-width: 500px;
        margin: 0 auto;
    }

    /* ========== Search Box ========== */
    .search-box {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(19, 48, 77, 0.1);
        margin-bottom: 2rem;
        border: 1px solid rgba(19, 48, 77, 0.08);
    }

    /* ========== Tipo búsqueda ========== */
    .tipo-busqueda-options {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .tipo-busqueda-option {
        flex: 1;
        min-width: 140px;
        max-width: 180px;
    }

    .tipo-busqueda-option input[type="radio"] {
        display: none;
    }

    .tipo-busqueda-option label {
        display: block;
        padding: 1.25rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
        font-weight: 600;
        color: #64748b;
    }

    .tipo-busqueda-option label i.icon-main {
        display: block;
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
        color: #13304D;
        transition: transform 0.3s ease;
    }

    .tipo-busqueda-option label .check-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 22px;
        height: 22px;
        background: #10b981;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.7rem;
        opacity: 0;
        transform: scale(0);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tipo-busqueda-option label {
        position: relative;
    }

    .tipo-busqueda-option label:hover {
        border-color: #13304D;
        transform: translateY(-2px);
    }

    .tipo-busqueda-option input[type="radio"]:checked + label {
        border-color: #13304D;
        background: linear-gradient(135deg, rgba(19, 48, 77, 0.06) 0%, rgba(19, 48, 77, 0.02) 100%);
        color: #13304D;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(19, 48, 77, 0.15);
    }

    .tipo-busqueda-option input[type="radio"]:checked + label i.icon-main {
        transform: scale(1.1);
    }

    .tipo-busqueda-option input[type="radio"]:checked + label .check-indicator {
        opacity: 1;
        transform: scale(1);
    }

    /* Indicador de selección actual */
    .seleccion-actual {
        text-align: center;
        margin-bottom: 1.5rem;
        padding: 0.75rem 1.25rem;
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        border-radius: 50px;
        color: white;
        font-weight: 600;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-left: 50%;
        transform: translateX(-50%);
    }

    .seleccion-actual i {
        font-size: 1rem;
    }

    .seleccion-actual span {
        transition: opacity 0.15s ease;
    }

    /* ========== Info Búsqueda ========== */
    .info-busqueda {
        background: linear-gradient(135deg, rgba(19, 48, 77, 0.06) 0%, rgba(19, 48, 77, 0.02) 100%);
        border-left: 4px solid #13304D;
        padding: 1rem 1.25rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
        color: #475569;
    }

    .info-busqueda i {
        color: #13304D;
        margin-right: 0.5rem;
    }

    /* ========== Input de búsqueda ========== */
    .search-input-wrapper {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .search-input-wrapper .form-label {
        color: #13304D;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }

    .search-input-wrapper .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .search-input-wrapper .form-control:focus {
        border-color: #13304D;
        box-shadow: 0 0 0 4px rgba(19, 48, 77, 0.1);
    }

    .btn-buscar {
        background: linear-gradient(135deg, #13304D 0%, #1a4a6e 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        width: 100%;
    }

    .btn-buscar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(19, 48, 77, 0.25);
        color: white;
    }

    /* ========== Resultados Header ========== */
    .resultados-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem 1.5rem;
        background: white;
        border-radius: 12px;
        border: 1px solid rgba(19, 48, 77, 0.08);
    }

    .resultados-header-icon {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #13304D 0%, #1a4a6e 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
    }

    .resultados-header h4 {
        margin: 0;
        color: #13304D;
        font-weight: 700;
        font-size: 1.1rem;
    }

    /* ========== Turno Card ========== */
    .turno-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(19, 48, 77, 0.1);
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(19, 48, 77, 0.08);
    }

    .turno-card:hover {
        box-shadow: 0 12px 35px rgba(19, 48, 77, 0.15);
        transform: translateY(-4px);
    }

    .turno-card-header {
        background: linear-gradient(135deg, #13304D 0%, #1a4a6e 100%);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .turno-codigo {
        font-size: 1.2rem;
        font-weight: 700;
        letter-spacing: 0.05rem;
    }

    .estado-badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .estado-pendiente {
        background: #fbbf24;
        color: #78350f;
    }

    .estado-confirmado {
        background: #10b981;
        color: white;
    }

    .estado-completado {
        background: #06b6d4;
        color: white;
    }

    .estado-en_curso {
        background: #f97316;
        color: white;
    }

    .estado-cancelado {
        background: #ef4444;
        color: white;
    }

    .turno-card-body {
        padding: 1.5rem;
    }

    /* ========== Fecha Destacada (compacta) ========== */
    .fecha-destacada {
        background: linear-gradient(135deg, rgba(19, 48, 77, 0.06) 0%, rgba(19, 48, 77, 0.02) 100%);
        padding: 1rem 1.25rem;
        border-radius: 12px;
        margin-bottom: 1.25rem;
        border: 1px solid rgba(19, 48, 77, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .fecha-destacada .fecha-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .fecha-destacada .dia {
        font-size: 2.25rem;
        font-weight: 700;
        color: #13304D;
        line-height: 1;
    }

    .fecha-destacada .fecha-texto {
        text-align: left;
    }

    .fecha-destacada .mes {
        font-size: 0.9rem;
        color: #13304D;
        font-weight: 600;
    }

    .fecha-destacada .dia-semana {
        font-size: 0.8rem;
        color: #64748b;
    }

    .fecha-destacada .hora {
        font-size: 1.1rem;
        font-weight: 700;
        color: #13304D;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        box-shadow: 0 2px 8px rgba(19, 48, 77, 0.1);
    }

    /* ========== Info Rows ========== */
    .turno-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .turno-info-row:last-child {
        border-bottom: none;
    }

    .turno-label {
        color: #64748b;
        font-weight: 500;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .turno-label i {
        color: #13304D;
        width: 16px;
        text-align: center;
        font-size: 0.8rem;
    }

    .turno-value {
        color: #13304D;
        font-weight: 600;
        text-align: right;
        font-size: 0.85rem;
    }

    /* ========== Acciones ========== */
    .turno-acciones {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .turno-acciones .btn {
        flex: 1;
        min-width: 120px;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.3s ease;
    }

    .btn-ver-detalles {
        background: linear-gradient(135deg, #13304D 0%, #1a4a6e 100%);
        color: white;
        border: none;
    }

    .btn-ver-detalles:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(19, 48, 77, 0.25);
        color: white;
    }

    .btn-ver-qr {
        background: white;
        color: #13304D;
        border: 2px solid #13304D;
    }

    .btn-ver-qr:hover {
        background: #13304D;
        color: white;
    }

    .btn-reprogramar {
        background: white;
        color: #f59e0b;
        border: 2px solid #f59e0b;
    }

    .btn-reprogramar:hover {
        background: #f59e0b;
        color: white;
    }

    .btn-cancelar {
        background: white;
        color: #ef4444;
        border: 2px solid #ef4444;
    }

    .btn-cancelar:hover {
        background: #ef4444;
        color: white;
    }

    /* ========== No Results ========== */
    .no-results {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(19, 48, 77, 0.1);
        border: 1px solid rgba(19, 48, 77, 0.08);
    }

    .no-results-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, rgba(19, 48, 77, 0.08) 0%, rgba(19, 48, 77, 0.04) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
    }

    .no-results-icon i {
        font-size: 2.5rem;
        color: #64748b;
    }

    .no-results h4 {
        color: #13304D;
        font-weight: 700;
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
    }

    .no-results p {
        color: #64748b;
        margin-bottom: 2rem;
        font-size: 1rem;
    }

    .btn-nuevo-turno {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
    }

    .btn-nuevo-turno:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.35);
        color: white;
    }

    /* ========== Modal Styles ========== */
    .modal-content {
        border: none;
        border-radius: 20px;
        overflow: hidden;
    }

    .modal-header-custom {
        background: linear-gradient(135deg, #13304D 0%, #1a4a6e 100%);
        color: white;
        padding: 2rem;
        text-align: center;
        position: relative;
    }

    .modal-header-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
    }

    .modal-header-custom h4 {
        font-weight: 700;
        font-size: 1.6rem;
        margin-bottom: 0.5rem;
    }

    .modal-estado-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.4rem 1rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .modal-body-custom {
        padding: 2rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    .modal-fecha-box {
        background: linear-gradient(135deg, rgba(19, 48, 77, 0.06) 0%, rgba(19, 48, 77, 0.02) 100%);
        padding: 2rem;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(19, 48, 77, 0.08);
    }

    .modal-qr-box {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 1.5rem;
        border: 2px solid #e2e8f0;
    }

    .modal-qr-box h5 {
        color: #13304D;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .modal-qr-img {
        max-width: 200px;
        margin: 0 auto;
        padding: 1rem;
        background: white;
        border: 3px solid #13304D;
        border-radius: 12px;
    }

    .modal-info-section {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 16px;
        margin-bottom: 1.5rem;
    }

    .modal-info-section h5 {
        color: #13304D;
        font-weight: 700;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .modal-info-item {
        padding: 0.5rem 0;
    }

    .modal-info-label {
        color: #64748b;
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .modal-info-value {
        color: #13304D;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .modal-info-value a {
        color: #13304D;
        text-decoration: none;
    }

    .modal-info-value a:hover {
        text-decoration: underline;
    }

    .modal-recordatorio {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-left: 4px solid #f59e0b;
        padding: 1.25rem;
        border-radius: 12px;
    }

    .modal-recordatorio h6 {
        color: #92400e;
        font-weight: 700;
        margin-bottom: 0.75rem;
    }

    .modal-recordatorio ul {
        color: #92400e;
        margin: 0;
        padding-left: 1.25rem;
        font-size: 0.9rem;
    }

    .modal-recordatorio li {
        margin-bottom: 0.5rem;
    }

    .modal-recordatorio li:last-child {
        margin-bottom: 0;
    }

    .modal-footer-custom {
        border-top: 1px solid #e2e8f0;
        padding: 1.25rem 2rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .modal-footer-custom .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    /* ========== Responsive ========== */
    @media (max-width: 768px) {
        .consultar-hero {
            padding: 2rem 1.5rem;
        }

        .consultar-hero h2 {
            font-size: 1.5rem;
        }

        .tipo-busqueda-options {
            flex-direction: column;
            align-items: center;
        }

        .tipo-busqueda-option {
            max-width: 100%;
            width: 100%;
        }

        .turno-card-header {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
            padding: 1.25rem;
        }

        .turno-card-body {
            padding: 1.5rem;
        }

        .turno-info-row {
            flex-direction: column;
            gap: 0.25rem;
            align-items: flex-start;
        }

        .turno-value {
            text-align: left;
        }

        .turno-acciones {
            flex-direction: column;
        }

        .turno-acciones .btn {
            min-width: 100%;
        }

        .modal-info-grid {
            grid-template-columns: 1fr;
        }

        .modal-footer-custom {
            flex-direction: column;
        }

        .modal-footer-custom .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="consultar-hero" data-aos="fade-down">
    <div class="consultar-hero-icon">
        <i class="fas fa-search"></i>
    </div>
    <h2>Consultar Turno</h2>
    <p>Buscá tu turno ingresando el código, dominio del vehículo o DNI</p>
</div>

<!-- Formulario de búsqueda -->
<div class="search-box" data-aos="fade-up">
    <form method="post" id="form_buscar">
        {% csrf_token %}

        <!-- Instrucción inicial -->
        <p style="text-align: center; color: #64748b; margin-bottom: 1.25rem; font-size: 0.95rem;">
            <i class="fas fa-hand-pointer me-2" style="color: #13304D;"></i>
            <strong>Paso 1:</strong> Seleccioná cómo querés buscar tu turno
        </p>

        <!-- Tipo de búsqueda -->
        <div class="tipo-busqueda-options">
            <div class="tipo-busqueda-option">
                <input type="radio" name="tipo_busqueda" id="tipo_codigo" value="codigo" checked>
                <label for="tipo_codigo">
                    <span class="check-indicator"><i class="fas fa-check"></i></span>
                    <i class="fas fa-ticket-alt icon-main"></i>
                    Código de Turno
                </label>
            </div>
            <div class="tipo-busqueda-option">
                <input type="radio" name="tipo_busqueda" id="tipo_dominio" value="dominio">
                <label for="tipo_dominio">
                    <span class="check-indicator"><i class="fas fa-check"></i></span>
                    <i class="fas fa-car icon-main"></i>
                    Dominio
                </label>
            </div>
            <div class="tipo-busqueda-option">
                <input type="radio" name="tipo_busqueda" id="tipo_dni" value="dni">
                <label for="tipo_dni">
                    <span class="check-indicator"><i class="fas fa-check"></i></span>
                    <i class="fas fa-id-card icon-main"></i>
                    DNI
                </label>
            </div>
        </div>

        <!-- Indicador de selección actual -->
        <div class="seleccion-actual" id="seleccion-actual">
            <i class="fas fa-check-circle"></i>
            <span id="texto-seleccion">Buscando por: Código de Turno</span>
        </div>

        <!-- Campo de búsqueda -->
        <div class="search-input-wrapper">
            <label for="valor_busqueda" class="form-label">
                <strong>Paso 2:</strong> <span id="label-busqueda">Ingresá el código de turno</span>
            </label>
            <input type="text" class="form-control"
                   id="valor_busqueda" name="valor_busqueda"
                   placeholder="Ej: TRN-ABC123"
                   required autofocus>
        </div>

        <button type="submit" class="btn btn-buscar">
            <i class="fas fa-search me-2"></i>Buscar Turno
        </button>
    </form>
</div>

<!-- Resultados de búsqueda -->
{% if turnos is not None %}
    {% if turnos %}
        <div id="resultados-busqueda" data-aos="fade-up">
            <div class="resultados-header">
                <div class="resultados-header-icon">
                    <i class="fas fa-list"></i>
                </div>
                <h4>
                    {% if turnos|length == 1 %}
                        Turno encontrado
                    {% else %}
                        {{ turnos|length }} turnos encontrados
                    {% endif %}
                </h4>
            </div>

            {% for turno in turnos %}
            <div class="turno-card" data-aos="fade-up" data-aos-delay="{% widthratio forloop.counter0 1 100 %}">
                <!-- Header -->
                <div class="turno-card-header">
                    <div>
                        <i class="fas fa-ticket-alt me-2"></i>
                        <span class="turno-codigo">{{ turno.codigo }}</span>
                    </div>
                    <div>
                        <span class="estado-badge estado-{{ turno.estado|lower }}">
                            {% if turno.estado == 'PENDIENTE' %}
                                <i class="fas fa-clock"></i>Pendiente
                            {% elif turno.estado == 'CONFIRMADO' %}
                                <i class="fas fa-check-circle"></i>Confirmado
                            {% elif turno.estado == 'EN_CURSO' %}
                                <i class="fas fa-spinner"></i>En Curso
                            {% elif turno.estado == 'COMPLETADO' %}
                                <i class="fas fa-check-double"></i>Completado
                            {% elif turno.estado == 'CANCELADO' %}
                                <i class="fas fa-times-circle"></i>Cancelado
                            {% endif %}
                        </span>
                    </div>
                </div>

                <!-- Body -->
                <div class="turno-card-body">
                    <!-- Fecha destacada (compacta) -->
                    <div class="fecha-destacada">
                        <div class="fecha-info">
                            <div class="dia">{{ turno.fecha|date:"d" }}</div>
                            <div class="fecha-texto">
                                <div class="mes">{{ turno.fecha|date:"F Y" }}</div>
                                <div class="dia-semana">{{ turno.fecha|date:"l" }}</div>
                            </div>
                        </div>
                        <div class="hora">
                            <i class="fas fa-clock"></i>{{ turno.hora_inicio|time:"H:i" }} hs
                        </div>
                    </div>

                    <!-- Información del turno -->
                    <div class="turno-info-row">
                        <span class="turno-label"><i class="fas fa-user"></i>Cliente</span>
                        <span class="turno-value">{{ turno.cliente.nombre }} {{ turno.cliente.apellido }}</span>
                    </div>
                    <div class="turno-info-row">
                        <span class="turno-label"><i class="fas fa-id-card"></i>DNI</span>
                        <span class="turno-value">{{ turno.cliente.dni }}</span>
                    </div>
                    <div class="turno-info-row">
                        <span class="turno-label"><i class="fas fa-car"></i>Vehículo</span>
                        <span class="turno-value">{{ turno.vehiculo.dominio }}</span>
                    </div>
                    <div class="turno-info-row">
                        <span class="turno-label"><i class="fas fa-clipboard-check"></i>Trámite</span>
                        <span class="turno-value">{{ turno.tipo_vehiculo.nombre }}</span>
                    </div>
                    <div class="turno-info-row">
                        <span class="turno-label"><i class="fas fa-building"></i>Taller</span>
                        <span class="turno-value">{{ turno.taller.get_nombre }}</span>
                    </div>

                    {% if turno.observaciones %}
                    <div class="turno-info-row">
                        <span class="turno-label"><i class="fas fa-comment"></i>Observaciones</span>
                        <span class="turno-value">{{ turno.observaciones }}</span>
                    </div>
                    {% endif %}

                    <!-- Acciones -->
                    <div class="turno-acciones">
                        <button type="button" class="btn btn-ver-detalles"
                                data-bs-toggle="modal" data-bs-target="#modalDetalle{{ turno.id }}">
                            <i class="fas fa-eye"></i>Ver Detalles
                        </button>
                        {% if turno.qr_code %}
                        <button type="button" class="btn btn-ver-qr"
                                onclick="descargarQR('{{ turno.qr_code.url }}', '{{ turno.codigo }}')">
                            <i class="fas fa-qrcode"></i>Ver QR
                        </button>
                        {% endif %}
                        {% if turno.puede_reprogramar %}
                        <button type="button" class="btn btn-reprogramar"
                                onclick="solicitarReprogramacion({{ turno.id }})">
                            <i class="fas fa-calendar-alt"></i>Reprogramar
                        </button>
                        {% endif %}
                        {% if turno.puede_cancelar %}
                        <button type="button" class="btn btn-cancelar"
                                onclick="confirmarCancelacion({{ turno.id }}, '{{ turno.codigo }}')">
                            <i class="fas fa-times-circle"></i>Cancelar
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    <!-- Modales de detalle -->
    {% for turno in turnos %}
    <div class="modal fade" id="modalDetalle{{ turno.id }}" tabindex="-1" aria-labelledby="modalDetalleLabel{{ turno.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <!-- Header del modal -->
                <div class="modal-header-custom">
                    <div class="modal-header-icon">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <h4 id="modalDetalleLabel{{ turno.id }}">{{ turno.codigo }}</h4>
                    <span class="modal-estado-badge">
                        {% if turno.estado == 'PENDIENTE' %}
                            <i class="fas fa-clock me-1"></i>Pendiente
                        {% elif turno.estado == 'CONFIRMADO' %}
                            <i class="fas fa-check-circle me-1"></i>Confirmado
                        {% elif turno.estado == 'EN_CURSO' %}
                            <i class="fas fa-spinner me-1"></i>En Curso
                        {% elif turno.estado == 'COMPLETADO' %}
                            <i class="fas fa-check-double me-1"></i>Completado
                        {% endif %}
                    </span>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="position: absolute; top: 1rem; right: 1rem;"></button>
                </div>

                <!-- Body del modal -->
                <div class="modal-body-custom">
                    <!-- Fecha y hora destacada -->
                    <div class="modal-fecha-box">
                        <div style="color: #64748b; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                            {{ turno.fecha|date:"F Y" }}
                        </div>
                        <div style="color: #13304D; font-size: 3.5rem; font-weight: 700; line-height: 1; margin: 0.25rem 0;">
                            {{ turno.fecha|date:"d" }}
                        </div>
                        <div style="color: #64748b; font-size: 1rem; margin-bottom: 1rem;">
                            {{ turno.fecha|date:"l" }}
                        </div>
                        <div style="display: inline-flex; align-items: center; gap: 10px; background: white; padding: 0.6rem 1.5rem; border-radius: 50px; color: #13304D; font-size: 1.5rem; font-weight: 700; box-shadow: 0 2px 10px rgba(19,48,77,0.1);">
                            <i class="fas fa-clock"></i>{{ turno.hora_inicio|time:"H:i" }} hs
                        </div>
                    </div>

                    <!-- QR Code -->
                    {% if turno.qr_code %}
                    <div class="modal-qr-box">
                        <h5><i class="fas fa-qrcode me-2"></i>Código QR</h5>
                        <div class="modal-qr-img">
                            <img src="{{ turno.qr_code.url }}" alt="QR Code" style="max-width: 100%; display: block;">
                        </div>
                        <p style="color: #64748b; font-size: 0.85rem; margin-top: 1rem; margin-bottom: 0;">
                            <i class="fas fa-info-circle me-1"></i>Mostrá este código al llegar al taller
                        </p>
                    </div>
                    {% endif %}

                    <!-- Información del turno -->
                    <div class="modal-info-section">
                        <h5><i class="fas fa-info-circle"></i>Detalles del Turno</h5>
                        <div class="modal-info-grid">
                            <div class="modal-info-item">
                                <div class="modal-info-label"><i class="fas fa-user"></i>Cliente</div>
                                <div class="modal-info-value">{{ turno.cliente.nombre }} {{ turno.cliente.apellido }}</div>
                            </div>
                            <div class="modal-info-item">
                                <div class="modal-info-label"><i class="fas fa-id-card"></i>DNI</div>
                                <div class="modal-info-value">{{ turno.cliente.dni }}</div>
                            </div>
                            <div class="modal-info-item">
                                <div class="modal-info-label"><i class="fas fa-car"></i>Vehículo</div>
                                <div class="modal-info-value">{{ turno.vehiculo.dominio }}</div>
                            </div>
                            <div class="modal-info-item">
                                <div class="modal-info-label"><i class="fas fa-clipboard-check"></i>Trámite</div>
                                <div class="modal-info-value">{{ turno.tipo_vehiculo.nombre }}</div>
                            </div>
                            <div class="modal-info-item" style="grid-column: span 2;">
                                <div class="modal-info-label"><i class="fas fa-building"></i>Taller</div>
                                <div class="modal-info-value">{{ turno.taller.get_nombre }}</div>
                            </div>
                            <div class="modal-info-item" style="grid-column: span 2;">
                                <div class="modal-info-label"><i class="fas fa-map-marker-alt"></i>Dirección</div>
                                <div class="modal-info-value">{{ turno.taller.get_direccion }}, {{ turno.taller.get_localidad.nombre }}</div>
                            </div>
                            <div class="modal-info-item">
                                <div class="modal-info-label"><i class="fas fa-phone"></i>Teléfono</div>
                                <div class="modal-info-value">
                                    <a href="tel:{{ turno.taller.get_telefono }}">{{ turno.taller.get_telefono }}</a>
                                </div>
                            </div>
                            {% if turno.taller.get_email %}
                            <div class="modal-info-item">
                                <div class="modal-info-label"><i class="fas fa-envelope"></i>Email</div>
                                <div class="modal-info-value" style="font-size: 0.85rem;">
                                    <a href="mailto:{{ turno.taller.get_email }}">{{ turno.taller.get_email }}</a>
                                </div>
                            </div>
                            {% endif %}
                            {% if turno.observaciones %}
                            <div class="modal-info-item" style="grid-column: span 2;">
                                <div class="modal-info-label"><i class="fas fa-comment"></i>Observaciones</div>
                                <div class="modal-info-value">{{ turno.observaciones }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Recordatorios -->
                    <div class="modal-recordatorio">
                        <h6><i class="fas fa-exclamation-circle me-2"></i>Recordatorios Importantes</h6>
                        <ul>
                            <li>Presentate <strong>10 minutos antes</strong> del horario</li>
                            <li>Traé tu <strong>DNI y cédula del vehículo</strong></li>
                            <li>El vehículo debe estar en <strong>condiciones técnicas adecuadas</strong></li>
                            <li>Mostrá el <strong>código QR o código de turno</strong></li>
                        </ul>
                    </div>
                </div>

                <!-- Footer del modal -->
                <div class="modal-footer-custom">
                    {% if turno.qr_code %}
                    <button type="button" class="btn btn-ver-qr"
                            onclick="descargarQR('{{ turno.qr_code.url }}', '{{ turno.codigo }}')">
                        <i class="fas fa-download"></i>Descargar QR
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-ver-detalles" onclick="imprimirTurno('{{ turno.codigo }}')">
                        <i class="fas fa-print"></i>Imprimir
                    </button>
                    <button type="button" class="btn btn-ver-qr" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
        <!-- No hay resultados -->
        <div class="no-results" id="sin-resultados" data-aos="zoom-in">
            <div class="no-results-icon">
                <i class="fas fa-search"></i>
            </div>
            <h4>No se encontraron turnos</h4>
            <p>
                No se encontraron turnos con
                {% if tipo_busqueda == 'codigo' %}
                    el código <strong>{{ valor_busqueda }}</strong>
                {% elif tipo_busqueda == 'dominio' %}
                    el dominio <strong>{{ valor_busqueda }}</strong>
                {% elif tipo_busqueda == 'dni' %}
                    el DNI <strong>{{ valor_busqueda }}</strong>
                {% endif %}
            </p>
            <a href="{% url 'turnero:step1_cliente' %}" class="btn btn-nuevo-turno">
                <i class="fas fa-calendar-plus"></i>Solicitar un Turno
            </a>
        </div>
    {% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Actualizar placeholder e indicador según tipo de búsqueda
    const textoSeleccion = document.getElementById('texto-seleccion');
    const labelBusqueda = document.getElementById('label-busqueda');
    const tiposTexto = {
        'codigo': {
            texto: 'Buscando por: Código de Turno',
            placeholder: 'Ej: TRN-ABC123',
            label: 'Ingresá el código de turno'
        },
        'dominio': {
            texto: 'Buscando por: Dominio del Vehículo',
            placeholder: 'Ej: ABC123 o AB123CD',
            label: 'Ingresá el dominio del vehículo'
        },
        'dni': {
            texto: 'Buscando por: DNI del Cliente',
            placeholder: 'Ej: 12345678',
            label: 'Ingresá el DNI del cliente'
        }
    };

    document.querySelectorAll('input[name="tipo_busqueda"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const input = document.getElementById('valor_busqueda');
            const tipo = tiposTexto[this.value];

            // Actualizar placeholder
            input.placeholder = tipo.placeholder;

            // Actualizar label del campo
            labelBusqueda.textContent = tipo.label;

            // Actualizar texto de selección con animación
            textoSeleccion.style.opacity = '0';
            setTimeout(() => {
                textoSeleccion.textContent = tipo.texto;
                textoSeleccion.style.opacity = '1';
            }, 150);

            input.focus();
        });
    });

    // Descargar QR
    function descargarQR(url, codigo) {
        const link = document.createElement('a');
        link.href = url;
        link.download = `QR_Turno_${codigo}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Código QR descargado correctamente', 'success');
    }

    // Imprimir turno - abre ventana de impresión dedicada
    function imprimirTurno(codigo) {
        window.open(`/turnero/imprimir/${codigo}/`, '_blank');
    }

    // Solicitar reprogramación (envía email)
    function solicitarReprogramacion(turnoId) {
        Swal.fire({
            title: '<i class="fas fa-calendar-alt text-warning me-2"></i> Reprogramar Turno',
            html: `
                <p>Te enviaremos un <strong>email con un link seguro</strong> para elegir una nueva fecha y hora.</p>
                <div class="alert alert-info mt-3 mb-0" style="font-size: 0.9rem;">
                    <i class="fas fa-info-circle me-2"></i>
                    El link será válido por <strong>48 horas</strong>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#f59e0b',
            confirmButtonText: '<i class="fas fa-paper-plane me-2"></i>Enviar email',
            cancelButtonText: 'Cancelar',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return fetch(`/turnero/solicitar-reprogramacion/${turnoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.message);
                    }
                    return data;
                })
                .catch(error => {
                    Swal.showValidationMessage(`Error: ${error.message}`);
                });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: '¡Email enviado!',
                    html: `
                        <p>${result.value.message}</p>
                        <p class="text-muted small mt-2">Revisá tu bandeja de entrada y spam</p>
                    `,
                    icon: 'success',
                    confirmButtonText: 'Entendido'
                });
            }
        });
    }

    // Confirmar cancelación
    function confirmarCancelacion(turnoId, codigo) {
        Swal.fire({
            title: '<i class="fas fa-exclamation-triangle text-danger me-2"></i> Cancelar Turno',
            html: `
                <p>¿Estás seguro de que querés cancelar el turno <strong>${codigo}</strong>?</p>
                <div class="alert alert-danger mt-3 mb-0" style="font-size: 0.9rem;">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Esta acción no se puede deshacer</strong>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: '<i class="fas fa-times-circle me-2"></i>Sí, cancelar turno',
            cancelButtonText: 'No, mantener turno',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return fetch(`/turnero/cancelar-definitivo/${turnoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.message);
                    }
                    return data;
                })
                .catch(error => {
                    Swal.showValidationMessage(`Error: ${error.message}`);
                });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: '¡Turno cancelado!',
                    text: result.value.message,
                    icon: 'success',
                    confirmButtonText: 'Entendido'
                }).then(() => {
                    location.reload();
                });
            }
        });
    }

    // Función helper para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Validación del formulario
    document.getElementById('form_buscar').addEventListener('submit', function(e) {
        const valor = document.getElementById('valor_busqueda').value.trim();

        if (!valor) {
            e.preventDefault();
            showWarning('Por favor, ingrese un valor para buscar', 'Campo Requerido');
            return;
        }
    });

    // Scroll automático a resultados cuando se realiza una búsqueda
    {% if turnos is not None %}
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            {% if turnos %}
            const resultados = document.getElementById('resultados-busqueda');
            if (resultados) {
                const offsetTop = resultados.getBoundingClientRect().top + window.pageYOffset - 20;
                window.scrollTo({
                    top: offsetTop,
                    behavior: 'smooth'
                });
            }
            {% else %}
            const sinResultados = document.getElementById('sin-resultados');
            if (sinResultados) {
                const offsetTop = sinResultados.getBoundingClientRect().top + window.pageYOffset - 20;
                window.scrollTo({
                    top: offsetTop,
                    behavior: 'smooth'
                });
            }
            {% endif %}
        }, 300);
    });
    {% endif %}
</script>
{% endblock %}
