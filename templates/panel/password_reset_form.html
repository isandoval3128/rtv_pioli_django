{% load static %}
<!doctype html>
<html lang="es">

<head>
<title>Restablecer Contraseña - Sistema RTV Pioli</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

<link rel="icon" href="{% static 'panel/assets/images/favicon.ico' %}" type="image/x-icon">

<!-- MAIN CSS -->
<link rel="stylesheet" href="{% static 'panel/assets/css/main.css' %}">

<!-- THEME CONFIG CSS -->
<link rel="stylesheet" href="{% static 'panel/assets/css/theme-config.css' %}">

<style>
    .password-strength {
        height: 4px;
        border-radius: 2px;
        margin-top: 5px;
        transition: all 0.3s ease;
    }
    .password-strength.weak { background: #dc3545; width: 33%; }
    .password-strength.medium { background: #ffc107; width: 66%; }
    .password-strength.strong { background: #28a745; width: 100%; }

    .password-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #6c757d;
        padding: 5px;
    }
    .password-toggle:hover { color: #13304D; }

    .form-group { position: relative; }

    .success-animation {
        display: none;
        text-align: center;
        padding: 30px 0;
    }
    .success-animation .checkmark {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #28a745;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: scaleIn 0.3s ease;
    }
    .success-animation .checkmark svg {
        width: 40px;
        height: 40px;
        stroke: white;
        stroke-width: 3;
        animation: drawCheck 0.4s ease 0.2s forwards;
        stroke-dasharray: 50;
        stroke-dashoffset: 50;
    }
    @keyframes scaleIn {
        from { transform: scale(0); }
        to { transform: scale(1); }
    }
    @keyframes drawCheck {
        to { stroke-dashoffset: 0; }
    }

    .error-box {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }
    .error-box i {
        font-size: 48px;
        color: #dc3545;
        margin-bottom: 15px;
    }
</style>

</head>

<body data-theme="theme-navy">
    <!-- WRAPPER -->
    <div id="wrapper">
        <div class="vertical-align-wrap">
            <div class="vertical-align-middle auth-main">
                <div class="auth-box">
                    <div class="card">
                        <div class="header text-center">
                            <img class="img-fluid img-register" src="{% static 'panel/assets/images/logo-azul.png' %}" alt="RTV Pioli" style="max-width: 250px; border-radius: 12px; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-5px)'; this.style.filter='drop-shadow(0 8px 15px rgba(0,0,0,0.2))';" onmouseout="this.style.transform='translateY(0)'; this.style.filter='none';">
                        </div>
                        <div class="body">
                            {% if token_invalido %}
                            <!-- Token invalido o expirado -->
                            <div class="error-box">
                                <div style="font-size: 48px; color: #dc3545; margin-bottom: 15px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                </div>
                                <h4 class="mb-3" style="color: #721c24;">Enlace no valido</h4>
                                <p style="color: #856404; margin-bottom: 20px;">{{ error }}</p>
                                <a href="{% url 'panel_login' %}" class="btn btn-primary">Ir al Login</a>
                            </div>
                            {% else %}
                            <!-- Formulario de nueva contraseña -->
                            <div id="form-container">
                                <h4 class="text-center mb-4" style="color: #13304D;">Nueva Contraseña</h4>
                                <p class="text-muted text-center mb-4" style="font-size: 14px;">
                                    Hola <strong>{{ usuario.first_name|default:usuario.username }}</strong>, ingresa tu nueva contraseña
                                </p>

                                <div id="error-alert" class="alert alert-danger" style="display: none;" role="alert"></div>

                                <form id="reset-form" class="form-auth-small">
                                    {% csrf_token %}
                                    <input type="hidden" name="token" value="{{ token }}">

                                    <div class="form-group mb-3">
                                        <label for="password" class="mb-1" style="font-size: 13px; color: #666;">Nueva Contraseña</label>
                                        <div style="position: relative;">
                                            <input type="password" class="form-control" id="password" name="password" placeholder="Ingresa tu nueva contraseña" required minlength="6">
                                            <span class="password-toggle" onclick="togglePassword('password', this)">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                                </svg>
                                            </span>
                                        </div>
                                        <div class="password-strength" id="password-strength"></div>
                                        <small class="text-muted">Minimo 6 caracteres</small>
                                    </div>

                                    <div class="form-group mb-4">
                                        <label for="password_confirm" class="mb-1" style="font-size: 13px; color: #666;">Repetir Contraseña</label>
                                        <div style="position: relative;">
                                            <input type="password" class="form-control" id="password_confirm" name="password_confirm" placeholder="Repite tu nueva contraseña" required minlength="6">
                                            <span class="password-toggle" onclick="togglePassword('password_confirm', this)">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                                </svg>
                                            </span>
                                        </div>
                                        <small id="match-indicator" class="text-muted"></small>
                                    </div>

                                    <button type="submit" class="btn btn-primary btn-lg btn-block w-100" id="btn-submit">
                                        <span id="btn-text">GUARDAR CONTRASEÑA</span>
                                        <span id="btn-loading" style="display: none;">
                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                            Guardando...
                                        </span>
                                    </button>
                                </form>
                            </div>

                            <!-- Mensaje de exito -->
                            <div class="success-animation" id="success-container">
                                <div class="checkmark">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 13L9 17L19 7" stroke="white" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <h4 style="color: #28a745; margin-bottom: 10px;">Contraseña Actualizada</h4>
                                <p class="text-muted mb-4">Tu contraseña ha sido cambiada correctamente.</p>
                                <p class="text-muted mb-3" style="font-size: 13px;">Seras redirigido al login en <span id="countdown">5</span> segundos...</p>
                                <a href="{% url 'panel_login' %}" class="btn btn-primary">Ir al Login ahora</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END WRAPPER -->

<script>
// Toggle password visibility
function togglePassword(inputId, toggle) {
    var input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        toggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/><path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z"/><path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/></svg>';
    } else {
        input.type = 'password';
        toggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>';
    }
}

// Password strength indicator
document.getElementById('password')?.addEventListener('input', function() {
    var strength = document.getElementById('password-strength');
    var value = this.value;

    strength.className = 'password-strength';

    if (value.length === 0) {
        strength.style.width = '0';
        return;
    }

    if (value.length < 6) {
        strength.classList.add('weak');
    } else if (value.length < 10 || !/[A-Z]/.test(value) || !/[0-9]/.test(value)) {
        strength.classList.add('medium');
    } else {
        strength.classList.add('strong');
    }

    checkPasswordMatch();
});

// Check password match
document.getElementById('password_confirm')?.addEventListener('input', checkPasswordMatch);

function checkPasswordMatch() {
    var password = document.getElementById('password').value;
    var confirm = document.getElementById('password_confirm').value;
    var indicator = document.getElementById('match-indicator');

    if (confirm.length === 0) {
        indicator.textContent = '';
        indicator.className = 'text-muted';
        return;
    }

    if (password === confirm) {
        indicator.textContent = 'Las contraseñas coinciden';
        indicator.className = 'text-success';
    } else {
        indicator.textContent = 'Las contraseñas no coinciden';
        indicator.className = 'text-danger';
    }
}

// Form submission
document.getElementById('reset-form')?.addEventListener('submit', function(e) {
    e.preventDefault();

    var password = document.getElementById('password').value;
    var confirm = document.getElementById('password_confirm').value;
    var token = document.querySelector('input[name="token"]').value;
    var errorAlert = document.getElementById('error-alert');
    var btnText = document.getElementById('btn-text');
    var btnLoading = document.getElementById('btn-loading');
    var btnSubmit = document.getElementById('btn-submit');

    // Validations
    if (password.length < 6) {
        errorAlert.textContent = 'La contraseña debe tener al menos 6 caracteres';
        errorAlert.style.display = 'block';
        return;
    }

    if (password !== confirm) {
        errorAlert.textContent = 'Las contraseñas no coinciden';
        errorAlert.style.display = 'block';
        return;
    }

    // Show loading
    errorAlert.style.display = 'none';
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline-block';
    btnSubmit.disabled = true;

    // Send request
    fetch('{% url "password_reset_confirm" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'token=' + encodeURIComponent(token) +
              '&password=' + encodeURIComponent(password) +
              '&password_confirm=' + encodeURIComponent(confirm)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('success-container').style.display = 'block';

            // Countdown and redirect
            var countdown = 5;
            var countdownEl = document.getElementById('countdown');
            var interval = setInterval(function() {
                countdown--;
                countdownEl.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interval);
                    window.location.href = '{% url "panel_login" %}';
                }
            }, 1000);
        } else {
            errorAlert.textContent = data.error || 'Ha ocurrido un error';
            errorAlert.style.display = 'block';
            btnText.style.display = 'inline-block';
            btnLoading.style.display = 'none';
            btnSubmit.disabled = false;
        }
    })
    .catch(error => {
        errorAlert.textContent = 'Error de conexion. Intenta nuevamente.';
        errorAlert.style.display = 'block';
        btnText.style.display = 'inline-block';
        btnLoading.style.display = 'none';
        btnSubmit.disabled = false;
    });
});
</script>

</body>
</html>
