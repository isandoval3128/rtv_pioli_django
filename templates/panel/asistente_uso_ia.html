{% extends "panel/base.html" %}
{% block extraCss %}
<style>
    /* Prevenir overflow horizontal en la página */
    html, body {
        overflow-x: hidden;
        max-width: 100%;
    }

    .card-body {
        overflow-x: hidden;
    }

    .container-fluid {
        overflow-x: hidden;
        max-width: 100%;
    }

    /* Stat cards */
    .stat-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 20px;
        text-align: center;
        background: #fff;
    }
    .stat-card .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #13304D;
    }
    .stat-card .stat-label {
        font-size: 12px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 5px;
    }
    .stat-card .stat-icon {
        font-size: 24px;
        color: #13304D;
        opacity: 0.3;
        margin-bottom: 10px;
    }

    /* ============================================= */
    /* Estilos profesionales para DataTable         */
    /* ============================================= */
    #data_table_ajax {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        font-size: 13px;
    }

    #data_table_ajax thead th {
        background: linear-gradient(135deg, #13304D 0%, #1a4066 100%);
        color: #fff;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 14px 12px;
        border: none;
        position: relative;
    }

    #data_table_ajax thead th:first-child {
        border-radius: 8px 0 0 0;
    }

    #data_table_ajax thead th:last-child {
        border-radius: 0 8px 0 0;
    }

    #data_table_ajax tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid #eef2f7;
    }

    #data_table_ajax tbody tr:hover {
        background-color: #f8fafc;
        transform: scale(1.002);
        box-shadow: 0 2px 8px rgba(19, 48, 77, 0.08);
    }

    #data_table_ajax tbody td {
        padding: 12px;
        vertical-align: middle;
        border-bottom: 1px solid #eef2f7;
        color: #374151;
    }

    #data_table_ajax tbody tr:last-child td {
        border-bottom: none;
    }

    #data_table_ajax tbody tr:nth-child(even) {
        background-color: #fafbfc;
    }

    #data_table_ajax tbody tr:nth-child(odd) {
        background-color: #ffffff;
    }

    #data_table_ajax .text-muted {
        color: #9ca3af !important;
        font-size: 11px;
    }

    /* DataTables wrapper styling */
    .dataTables_wrapper {
        padding-top: 10px;
    }

    .dataTables_wrapper .dataTables_filter input {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 13px;
        transition: all 0.2s ease;
    }

    .dataTables_wrapper .dataTables_filter input:focus {
        border-color: var(--theme-primary);
        box-shadow: 0 0 0 3px rgba(19, 48, 77, 0.1);
        outline: none;
    }

    .dataTables_wrapper .dataTables_info {
        color: #6b7280;
        font-size: 13px;
        padding-top: 15px;
    }

    .dataTables_wrapper .dataTables_paginate {
        padding-top: 15px;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        border-radius: 6px !important;
        margin: 0 2px;
        padding: 6px 12px !important;
        border: 1px solid #e5e7eb !important;
        background: #fff !important;
        color: #374151 !important;
        transition: all 0.2s ease;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: #f3f4f6 !important;
        border-color: #d1d5db !important;
        color: var(--theme-primary) !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: var(--theme-primary) !important;
        border-color: var(--theme-primary) !important;
        color: #fff !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Card contenedora mejorada */
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .card .card-body {
        padding: 24px;
    }

    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #eef2f7;
    }

    /* Estilos para la sección de filtros colapsable */
    .filtros-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .btn-toggle-filtros {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background-color: var(--theme-primary);
        border: 1px solid var(--theme-primary);
        color: white;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-toggle-filtros:hover {
        background-color: var(--theme-primary-dark);
        border-color: var(--theme-primary-dark);
    }

    .btn-toggle-filtros i {
        transition: transform 0.3s ease;
    }

    .btn-toggle-filtros.collapsed i.fa-chevron-down {
        transform: rotate(0deg);
    }

    .btn-toggle-filtros:not(.collapsed) i.fa-chevron-down {
        transform: rotate(180deg);
    }

    .filtros-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background-color: #e6603a;
        color: white;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 4px;
    }

    .filtros-badge.hidden {
        display: none;
    }

    .filtros-container {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .filtros-container.collapsed {
        display: none;
    }

    .filtros-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        width: 100%;
        box-sizing: border-box;
    }

    .filtro-item {
        box-sizing: border-box;
    }

    .filtro-item label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }

    .filtro-item .form-control {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box;
        font-size: 14px;
        height: 38px;
        border-radius: 4px;
    }

    .filtros-acciones {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        padding-bottom: 2px;
        flex-shrink: 0;
    }

    .btn-filtrar {
        background-color: var(--theme-primary);
        border-color: var(--theme-primary);
        color: white;
        width: 38px;
        height: 38px;
        padding: 0;
        font-size: 15px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-filtrar:hover {
        background-color: var(--theme-primary-dark);
        border-color: var(--theme-primary-dark);
        color: white;
    }

    .btn-limpiar {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
        width: 38px;
        height: 38px;
        padding: 0;
        font-size: 15px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-limpiar:hover {
        background-color: #5a6268;
        border-color: #5a6268;
        color: white;
    }

    /* Badges */
    .badge-estado {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        font-size: 11px;
        font-weight: 600;
        border-radius: 20px;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .badge-ok {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    .badge-error {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }

    /* Vista Desktop / Móvil */
    .vista-desktop {
        display: block;
    }

    .vista-mobile {
        display: none;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .filtros-row {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 992px) {
        .filtros-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .vista-desktop {
            display: none !important;
        }

        .vista-mobile {
            display: block !important;
        }

        .dt-buttons {
            display: none !important;
        }
    }

    @media (max-width: 576px) {
        .filtros-row {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .filtros-container {
            padding: 12px;
        }

        .btn-toggle-filtros {
            width: 100%;
            justify-content: center;
        }
    }

    /* Botón flotante volver arriba */
    .btn-volver-arriba {
        position: fixed;
        right: 20px;
        bottom: 90px;
        width: 45px;
        height: 45px;
        background-color: var(--theme-primary);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 999;
    }

    .btn-volver-arriba.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .btn-volver-arriba:hover {
        background-color: var(--theme-primary-dark);
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    @media (max-width: 768px) {
        .btn-volver-arriba {
            right: 15px;
            bottom: 85px;
            width: 42px;
            height: 42px;
            font-size: 16px;
        }
    }
</style>
{% endblock %}

{% block main %}
{% load static %}

<div id="main-content" class="profilepage_2 blog-page">
    <div class="container-fluid">
        <div class="block-header">
            <div class="row g-3">
                <div class="col-lg-5 col-md-8 col-sm-12">
                    <h2><a href="javascript:void(0);" class="btn btn-xs btn-link btn-toggle-fullwidth"><i class="fa fa-arrow-right"></i></a>
                        {{ titulo }}</h2>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'panel_home' %}"><i class="icon-home text-orange"></i></a></li>
                        <li class="breadcrumb-item">Asistente IA</li>
                        <li class="breadcrumb-item active">{{ titulo }}</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Cards de estadísticas -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa fa-bolt"></i></div>
                    <div class="stat-value">{{ total_calls }}</div>
                    <div class="stat-label">Llamadas IA Hoy</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa fa-money"></i></div>
                    <div class="stat-value">{{ total_tokens }}</div>
                    <div class="stat-label">Tokens Consumidos</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa fa-usd"></i></div>
                    <div class="stat-value">${{ costo_total }}</div>
                    <div class="stat-label">Costo Estimado Hoy</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa fa-database"></i></div>
                    <div class="stat-value">{{ cache_hit_rate }}%</div>
                    <div class="stat-label">Cache Hit Rate</div>
                </div>
            </div>
        </div>

        <div class="row clearfix">
            <div class="col-lg-12 col-md-12">
                <div class="card">
                    <div class="card-body">
                        <!-- Botón para mostrar/ocultar filtros -->
                        <div class="filtros-header">
                            <button type="button" class="btn-toggle-filtros collapsed" id="btn-toggle-filtros">
                                <i class="fa fa-filter"></i>
                                <span>Filtros</span>
                                <span class="filtros-badge hidden" id="filtros-badge">0</span>
                                <i class="fa fa-chevron-down"></i>
                            </button>
                        </div>

                        <!-- Filtros Avanzados (colapsable) -->
                        <div class="filtros-container collapsed" id="filtros-container">
                            <div class="filtros-row">
                                <div class="filtro-item">
                                    <label for="filtro-fecha-desde">Fecha Desde</label>
                                    <input type="date" class="form-control" id="filtro-fecha-desde">
                                </div>

                                <div class="filtro-item">
                                    <label for="filtro-fecha-hasta">Fecha Hasta</label>
                                    <input type="date" class="form-control" id="filtro-fecha-hasta">
                                </div>

                                <div class="filtro-item">
                                    <label for="filtro-exitoso">Estado</label>
                                    <select class="form-control" id="filtro-exitoso">
                                        <option value="">Todos</option>
                                        <option value="true">Exitosos</option>
                                        <option value="false">Con error</option>
                                    </select>
                                </div>

                                <div class="filtros-acciones">
                                    <button type="button" class="btn btn-filtrar" id="btn-aplicar-filtros" title="Filtrar">
                                        <i class="fa fa-search"></i>
                                    </button>
                                    <button type="button" class="btn btn-limpiar" id="btn-limpiar-filtros" title="Limpiar">
                                        <i class="fa fa-eraser"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Vista Desktop (Tabla) -->
                        <div class="vista-desktop">
                            <div class="row clearfix">
                                <div class="col-lg-12 col-md-12">
                                    <table id="data_table_ajax" class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Proveedor</th>
                                                <th>Modelo</th>
                                                <th>Tokens In</th>
                                                <th>Tokens Out</th>
                                                <th>Costo</th>
                                                <th>Latencia</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Vista Móvil (Cards) -->
                        <div class="vista-mobile">
                            <div id="uso-cards-container" style="display:flex; flex-direction:column; gap:14px;">
                                <div style="text-align:center; padding:50px 20px; color:#9ca3af;">
                                    <i class="fa fa-spinner fa-spin" style="font-size:36px; margin-bottom:12px; color:var(--theme-primary); opacity:0.8;"></i>
                                    <p>Cargando registros...</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Botón flotante volver arriba -->
<button type="button" class="btn-volver-arriba" id="btn-volver-arriba" title="Volver arriba">
    <i class="fa fa-chevron-up"></i>
</button>

{% endblock %}

{% block extraJS %}
<script>
$(document).ready(function(){
    cargarTabla();

    // Toggle para mostrar/ocultar filtros
    $('#btn-toggle-filtros').on('click', function(){
        var $btn = $(this);
        var $container = $('#filtros-container');

        $btn.toggleClass('collapsed');
        $container.toggleClass('collapsed');

        var $span = $btn.find('span').first();
        if ($btn.hasClass('collapsed')) {
            $span.text('Filtros');
        } else {
            $span.text('Ocultar Filtros');
        }
    });

    // Evento para el botón Filtrar
    $('#btn-aplicar-filtros').on('click', function(){
        cargarTabla();
        actualizarBadgeFiltros();
    });

    // Evento para el botón Limpiar
    $('#btn-limpiar-filtros').on('click', function(){
        limpiarFiltros();
    });

    // Botón volver arriba
    var $btnVolverArriba = $('#btn-volver-arriba');
    $(window).on('scroll', function() {
        if ($(this).scrollTop() > 300) {
            $btnVolverArriba.addClass('visible');
        } else {
            $btnVolverArriba.removeClass('visible');
        }
    });

    $btnVolverArriba.on('click', function() {
        $('html, body').animate({ scrollTop: 0 }, 400);
    });
});

function actualizarBadgeFiltros() {
    var count = 0;
    if ($('#filtro-fecha-desde').val()) count++;
    if ($('#filtro-fecha-hasta').val()) count++;
    if ($('#filtro-exitoso').val()) count++;

    var $badge = $('#filtros-badge');
    if (count > 0) {
        $badge.text(count).removeClass('hidden');
    } else {
        $badge.addClass('hidden');
    }
}

function limpiarFiltros() {
    $('#filtro-fecha-desde').val('');
    $('#filtro-fecha-hasta').val('');
    $('#filtro-exitoso').val('');
    $('#filtros-badge').addClass('hidden');
    cargarTabla();
}

var table;

function cargarTabla(){
    $('#data_table_ajax').dataTable().fnClearTable();
    $('#data_table_ajax').dataTable().fnDestroy();

    var valores = {
        "csrfmiddlewaretoken": '{{ csrf_token }}',
        "filtro_fecha_desde": $("#filtro-fecha-desde").val() || '',
        "filtro_fecha_hasta": $("#filtro-fecha-hasta").val() || '',
        "filtro_exitoso": $("#filtro-exitoso").val() || ''
    };

    table = $('#data_table_ajax').DataTable({
        autoWidth: false,
        processing: true,
        searching: true,
        paging: true,
        pageLength: 25,
        order: [[0, 'desc']],
        language: {
            url: "https://cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json"
        },
        ajax: {
            "url": "{% url 'asistente_uso_ia_ajax' %}",
            "data": valores,
            "type": "POST",
            "dataSrc": ""
        },
        columns: [
            { data: "fecha" },
            { data: "provider" },
            { data: "model", render: function(data) {
                return '<span style="font-family: monospace; font-size: 12px;">' + data + '</span>';
            }},
            { data: "tokens_input", render: function(data) {
                return '<span style="font-weight:600;">' + data + '</span>';
            }},
            { data: "tokens_output", render: function(data) {
                return '<span style="font-weight:600;">' + data + '</span>';
            }},
            { data: "costo" },
            { data: "latencia" },
            { data: "exitoso", render: function(data, type, row) {
                if (data) {
                    return '<span class="badge-estado badge-ok"><i class="fa fa-check"></i> OK</span>';
                } else {
                    return '<span class="badge-estado badge-error" title="' + (row.error || '') + '"><i class="fa fa-times"></i> Error</span>';
                }
            }}
        ],
        drawCallback: function() {
            renderMobileCards(this.api().data().toArray());
        }
    });
}

function renderMobileCards(data) {
    var container = $('#uso-cards-container');

    if (data.length === 0) {
        container.html('<div style="text-align:center; padding:50px 20px; color:#9ca3af; background:linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius:12px; border:1px dashed #e5e7eb;"><i class="fa fa-bar-chart" style="font-size:52px; margin-bottom:16px; color:#d1d5db;"></i><p>No se encontraron registros</p></div>');
        return;
    }

    var html = '';
    data.forEach(function(row) {
        var estadoBadge = row.exitoso
            ? '<span class="badge-estado badge-ok"><i class="fa fa-check"></i> OK</span>'
            : '<span class="badge-estado badge-error"><i class="fa fa-times"></i> Error</span>';

        html += '<div style="background:#fff; border:none; border-radius:12px; padding:0; box-shadow:0 1px 3px rgba(0,0,0,0.04),0 4px 12px rgba(0,0,0,0.04); position:relative; overflow:visible;">';
        html += '<div style="position:absolute; left:0; top:0; bottom:0; width:4px; background:linear-gradient(180deg, var(--theme-primary) 0%, #1a4066 100%); border-radius:12px 0 0 12px;"></div>';
        html += '<div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-bottom:1px solid #eef2f7; border-radius:12px 12px 0 0;">';
        html += '<span style="font-weight:600; color:#13304D; font-size:13px;">' + row.fecha + '</span>' + estadoBadge;
        html += '</div>';
        html += '<div style="padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px 16px;">';
        html += '<div><span style="font-size:10px; color:#9ca3af; text-transform:uppercase; letter-spacing:0.5px; font-weight:600; display:block; margin-bottom:3px;">Modelo</span><span style="font-size:12px; font-family:monospace; color:#374151;">' + row.model + '</span></div>';
        html += '<div><span style="font-size:10px; color:#9ca3af; text-transform:uppercase; letter-spacing:0.5px; font-weight:600; display:block; margin-bottom:3px;">Costo</span><span style="font-size:13px; color:#374151; font-weight:500;">' + row.costo + '</span></div>';
        html += '<div><span style="font-size:10px; color:#9ca3af; text-transform:uppercase; letter-spacing:0.5px; font-weight:600; display:block; margin-bottom:3px;">Tokens In/Out</span><span style="font-size:13px; color:#374151; font-weight:600;">' + row.tokens_input + ' / ' + row.tokens_output + '</span></div>';
        html += '<div><span style="font-size:10px; color:#9ca3af; text-transform:uppercase; letter-spacing:0.5px; font-weight:600; display:block; margin-bottom:3px;">Latencia</span><span style="font-size:13px; color:#374151; font-weight:500;">' + row.latencia + '</span></div>';
        html += '</div></div>';
    });
    container.html(html);
}
</script>
{% endblock %}
