<style>
    /* ========================================
       FORM TURNO - DISENO PROFESIONAL
       ======================================== */

    .turno-form-container {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Header del Modal */
    .turno-form-header {
        background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-primary-dark, #3d1730) 100%);
        padding: 1.25rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .turno-form-header h5 {
        margin: 0;
        color: white;
        font-size: 1.15rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .turno-form-header .close-btn {
        background: rgba(255,255,255,0.15);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .turno-form-header .close-btn:hover {
        background: rgba(255,255,255,0.25);
    }

    /* Body del Form */
    .turno-form-body {
        padding: 1.5rem;
        background: #f8fafc;
        max-height: 65vh;
        overflow-y: auto;
    }

    /* Secciones */
    .form-section {
        background: white;
        border-radius: 12px;
        margin-bottom: 1.25rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .form-section:last-child {
        margin-bottom: 0;
    }

    .section-header {
        background: linear-gradient(to right, #f8fafc, white);
        padding: 0.875rem 1.25rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: var(--theme-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    .section-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }

    .section-subtitle {
        font-size: 0.75rem;
        color: #64748b;
        margin-top: 0.15rem;
    }

    .section-body {
        padding: 1.25rem;
    }

    /* Campos del formulario */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-row:last-child {
        margin-bottom: 0;
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: #475569;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .form-label i {
        color: var(--theme-primary);
        font-size: 0.85rem;
    }

    .form-label .required {
        color: #ef4444;
        margin-left: 0.15rem;
    }

    .form-control {
        border: 1.5px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.65rem 0.875rem;
        font-size: 0.9rem;
        transition: all 0.2s;
        background: white;
    }

    .form-control:focus {
        border-color: var(--theme-primary);
        box-shadow: 0 0 0 3px rgba(87, 32, 67, 0.1);
        outline: none;
    }

    .form-control:disabled,
    .form-control[readonly] {
        background: #f1f5f9;
        color: #64748b;
        cursor: not-allowed;
    }

    /* Campo readonly con valor destacado */
    .readonly-value {
        background: #f8fafc;
        border: 1.5px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.65rem 0.875rem;
        font-size: 0.9rem;
        color: #1e293b;
        font-weight: 500;
    }

    .readonly-value.highlight {
        background: linear-gradient(135deg, #faf5f8 0%, #f8fafc 100%);
        border-color: var(--theme-primary);
        border-left-width: 4px;
    }

    /* Input group para botones de agregar */
    .input-with-btn {
        display: flex;
        gap: 0.5rem;
    }

    .input-with-btn .form-control,
    .input-with-btn .select2-container {
        flex: 1;
    }

    .btn-add {
        width: 42px;
        height: 42px;
        border-radius: 8px;
        background: var(--theme-primary);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .btn-add:hover {
        background: var(--theme-primary-dark, #3d1730);
        transform: translateY(-1px);
    }

    /* Select2 personalizado */
    .select2-container--default .select2-selection--single {
        height: 42px;
        border: 1.5px solid #e2e8f0;
        border-radius: 8px;
        background: white;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 40px;
        padding-left: 0.875rem;
        color: #1e293b;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px;
        right: 8px;
    }

    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: var(--theme-primary);
        box-shadow: 0 0 0 3px rgba(87, 32, 67, 0.1);
    }

    /* Textarea */
    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    /* Checkboxes mejorados */
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s;
    }

    .checkbox-item:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--theme-primary);
        cursor: pointer;
    }

    .checkbox-item label {
        margin: 0;
        cursor: pointer;
        font-size: 0.85rem;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .checkbox-item label i {
        font-size: 1rem;
    }

    .checkbox-item.checked {
        background: #ecfdf5;
        border-color: #10b981;
    }

    .checkbox-item.checked label {
        color: #065f46;
    }

    /* Info text */
    .form-text {
        font-size: 0.75rem;
        color: #94a3b8;
        margin-top: 0.4rem;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .form-text i {
        font-size: 0.7rem;
    }

    /* Footer del Form */
    .turno-form-footer {
        padding: 1rem 1.5rem;
        background: white;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .btn-submit {
        background: var(--theme-primary);
        border: none;
        color: white;
        padding: 0.65rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-submit:hover {
        background: var(--theme-primary-dark, #3d1730);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(87, 32, 67, 0.3);
    }

    .btn-cancel {
        background: white;
        border: 1.5px solid #e2e8f0;
        color: #64748b;
        padding: 0.65rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-cancel:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #475569;
    }

    /* Flatpickr personalizado */
    .flatpickr-input {
        background-color: #fff !important;
    }

    .flatpickr-input:disabled {
        background-color: #f1f5f9 !important;
    }

    .flatpickr-day.flatpickr-disabled,
    .flatpickr-day.flatpickr-disabled:hover {
        color: #ccc !important;
        background: #f5f5f5 !important;
        cursor: not-allowed !important;
        text-decoration: line-through;
    }

    .flatpickr-day.selected {
        background: var(--theme-primary) !important;
        border-color: var(--theme-primary) !important;
    }

    .flatpickr-day.today {
        border-color: var(--theme-primary) !important;
    }

    .flatpickr-day:hover {
        background: rgba(87, 32, 67, 0.1) !important;
    }

    .flatpickr-months .flatpickr-month {
        background: var(--theme-primary) !important;
        color: white !important;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-current-month input.cur-year {
        color: white !important;
    }

    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
        fill: white !important;
        color: white !important;
    }

    .flatpickr-weekdays {
        background: #f8f9fa !important;
    }

    .flatpickr-weekday {
        color: var(--theme-primary) !important;
        font-weight: 600 !important;
    }

    /* Alert info */
    .info-alert {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .info-alert i {
        color: #3b82f6;
        font-size: 1.1rem;
        margin-top: 0.1rem;
    }

    .info-alert-text {
        font-size: 0.85rem;
        color: #1e40af;
        line-height: 1.4;
    }

    /* Responsive - Tablets */
    @media (max-width: 992px) {
        .turno-form-body {
            max-height: 60vh;
        }

        .form-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Responsive - Moviles */
    @media (max-width: 768px) {
        .turno-form-header {
            padding: 1rem 1.25rem;
        }

        .turno-form-header h5 {
            font-size: 1rem;
        }

        .turno-form-body {
            padding: 1rem;
            max-height: 55vh;
        }

        .form-section {
            margin-bottom: 1rem;
            border-radius: 10px;
        }

        .section-header {
            padding: 0.75rem 1rem;
        }

        .section-icon {
            width: 32px;
            height: 32px;
            font-size: 0.9rem;
        }

        .section-title {
            font-size: 0.9rem;
        }

        .section-subtitle {
            font-size: 0.7rem;
        }

        .section-body {
            padding: 1rem;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 0.875rem;
        }

        .form-label {
            font-size: 0.75rem;
        }

        .form-control {
            padding: 0.6rem 0.75rem;
            font-size: 0.85rem;
        }

        .readonly-value {
            padding: 0.6rem 0.75rem;
            font-size: 0.85rem;
        }

        .btn-add {
            width: 38px;
            height: 38px;
        }

        .select2-container--default .select2-selection--single {
            height: 38px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        .checkbox-group {
            grid-template-columns: 1fr;
        }

        .checkbox-item {
            padding: 0.65rem 0.875rem;
        }

        .checkbox-item label {
            font-size: 0.8rem;
        }

        .turno-form-footer {
            padding: 1rem;
            flex-direction: column;
            gap: 0.5rem;
        }

        .turno-form-footer button {
            width: 100%;
            justify-content: center;
            padding: 0.75rem 1rem;
        }

        .info-alert {
            padding: 0.65rem 0.875rem;
        }

        .info-alert i {
            font-size: 1rem;
        }

        .info-alert-text {
            font-size: 0.8rem;
        }
    }

    /* Responsive - Moviles pequenos */
    @media (max-width: 480px) {
        .turno-form-header {
            padding: 0.875rem 1rem;
        }

        .turno-form-header h5 {
            font-size: 0.95rem;
            gap: 0.4rem;
        }

        .turno-form-header .close-btn {
            width: 32px;
            height: 32px;
            font-size: 1.1rem;
        }

        .turno-form-body {
            padding: 0.75rem;
        }

        .form-section {
            margin-bottom: 0.75rem;
        }

        .section-header {
            padding: 0.65rem 0.875rem;
            gap: 0.5rem;
        }

        .section-icon {
            width: 28px;
            height: 28px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .section-title {
            font-size: 0.85rem;
        }

        .section-body {
            padding: 0.875rem;
        }

        .form-row {
            gap: 0.75rem;
        }

        .form-label {
            font-size: 0.7rem;
            margin-bottom: 0.4rem;
        }

        .form-control {
            padding: 0.55rem 0.65rem;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .readonly-value {
            padding: 0.55rem 0.65rem;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        textarea.form-control {
            min-height: 80px;
        }

        .turno-form-footer {
            padding: 0.875rem;
        }

        .btn-submit, .btn-cancel {
            font-size: 0.85rem;
            padding: 0.65rem 1rem;
        }
    }
</style>

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="turno-form-container">
    <!-- Header -->
    <div class="turno-form-header">
        <h5>
            <i class="fa fa-{% if turno %}edit{% else %}calendar-plus{% endif %}"></i>
            {{ titulo }}
        </h5>
        <button type="button" class="close-btn" onclick="$('#modal-lg').modal('hide');">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <form id="turno_form" method="POST" novalidate>
        {% csrf_token %}
        <input type="hidden" id="pk" name="pk" value="{% if pk %}{{ pk }}{% endif %}">

        <div class="turno-form-body">
            {% if turno %}
            <!-- Info de edicion -->
            <div class="info-alert">
                <i class="fa fa-info-circle"></i>
                <div class="info-alert-text">
                    <strong>Modo Edicion:</strong> Los datos del cliente, vehiculo, taller y tipo de tramite no pueden modificarse.
                    Para cambiarlos, cancele este turno y cree uno nuevo.
                </div>
            </div>
            {% endif %}

            <!-- SECCION: CLIENTE -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fa fa-user"></i>
                    </div>
                    <div>
                        <h6 class="section-title">Cliente</h6>
                        <p class="section-subtitle">Datos del titular del turno</p>
                    </div>
                </div>
                <div class="section-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-user"></i>
                                Cliente <span class="required">*</span>
                            </label>
                            {% if turno %}
                            <div class="readonly-value highlight">
                                <i class="fa fa-id-card me-2" style="color: var(--theme-primary);"></i>
                                {{ turno.cliente.dni }} - {{ turno.cliente.nombre }} {{ turno.cliente.apellido }}
                            </div>
                            <input type="hidden" id="cliente" name="cliente" value="{{ turno.cliente.id }}">
                            {% else %}
                            <div class="input-with-btn">
                                <select id="cliente" name="cliente" class="form-control select2" required>
                                    <option value="">Buscar cliente por DNI o nombre...</option>
                                    {% for c in clientes %}
                                    <option value="{{ c.id }}">{{ c.dni }} - {{ c.nombre }} {{ c.apellido }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn-add btn-agregar-cliente" title="Agregar nuevo cliente">
                                    <i class="fa fa-plus"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-car"></i>
                                Vehiculo <span class="required">*</span>
                            </label>
                            {% if turno %}
                            <div class="readonly-value highlight">
                                <i class="fa fa-car me-2" style="color: var(--theme-primary);"></i>
                                {{ turno.vehiculo.dominio }}
                                {% if turno.vehiculo.marca %} - {{ turno.vehiculo.marca }}{% endif %}
                                {% if turno.vehiculo.modelo %} {{ turno.vehiculo.modelo }}{% endif %}
                                {% if turno.vehiculo.tiene_gnc %}<span class="badge bg-warning text-dark ms-2">GNC</span>{% endif %}
                            </div>
                            <input type="hidden" id="vehiculo" name="vehiculo" value="{{ turno.vehiculo.id }}">
                            {% else %}
                            <div class="input-with-btn">
                                <select id="vehiculo" name="vehiculo" class="form-control select2" required>
                                    <option value="">Primero seleccione un cliente</option>
                                </select>
                                <button type="button" class="btn-add btn-agregar-vehiculo" title="Agregar nuevo vehiculo">
                                    <i class="fa fa-plus"></i>
                                </button>
                            </div>
                            <span class="form-text"><i class="fa fa-info-circle"></i> Seleccione un cliente para ver sus vehiculos</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCION: TURNO -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fa fa-calendar"></i>
                    </div>
                    <div>
                        <h6 class="section-title">Datos del Turno</h6>
                        <p class="section-subtitle">Taller, fecha y horario de la cita</p>
                    </div>
                </div>
                <div class="section-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-building"></i>
                                Taller <span class="required">*</span>
                            </label>
                            {% if turno %}
                            <div class="readonly-value">{{ turno.taller.get_nombre }}</div>
                            <input type="hidden" id="taller" name="taller" value="{{ turno.taller.id }}">
                            {% else %}
                            <select id="taller" name="taller" class="form-control select2" required>
                                <option value="">Seleccione un taller...</option>
                                {% for t in talleres %}
                                <option value="{{ t.id }}">{{ t.get_nombre }}</option>
                                {% endfor %}
                            </select>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-tag"></i>
                                Tipo de Tramite <span class="required">*</span>
                            </label>
                            {% if turno %}
                            <div class="readonly-value">{{ turno.tipo_vehiculo.nombre_normalizado }}</div>
                            <input type="hidden" id="tipo_vehiculo" name="tipo_vehiculo" value="{{ turno.tipo_vehiculo.id }}">
                            {% else %}
                            <select id="tipo_vehiculo" name="tipo_vehiculo" class="form-control select2" required disabled>
                                <option value="">Primero seleccione un taller</option>
                            </select>
                            <span class="form-text" id="help-tipo-tramite"><i class="fa fa-info-circle"></i> Seleccione un taller para ver los tramites</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if turno %}
                    <!-- MODO EDICION: Mostrar fecha actual + campo para cambiar -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-calendar"></i>
                                Fecha Actual del Turno
                            </label>
                            <div class="readonly-value highlight">
                                <i class="fa fa-calendar-check-o me-2" style="color: var(--theme-primary);"></i>
                                {{ turno.fecha|date:'d/m/Y' }} ({{ turno.fecha|date:'l' }})
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-calendar-plus-o"></i>
                                Cambiar Fecha <span class="required">*</span>
                            </label>
                            <input type="text" id="fecha" name="fecha" class="form-control" required
                                   placeholder="Seleccione una nueva fecha">
                            <span class="form-text" id="info-dias-atencion" style="display: none;">
                                <i class="fa fa-calendar-check-o"></i>
                                <span id="texto-dias-atencion"></span>
                            </span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-clock-o"></i>
                                Horario Actual
                            </label>
                            <div class="readonly-value highlight">
                                <i class="fa fa-clock-o me-2" style="color: var(--theme-primary);"></i>
                                {{ turno.hora_inicio|time:'H:i' }} - {{ turno.hora_fin|time:'H:i' }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-clock-o"></i>
                                Cambiar Horario <span class="required">*</span>
                            </label>
                            <select id="horario_turno" class="form-control select2">
                                <option value="">Primero seleccione una nueva fecha</option>
                            </select>
                            <input type="hidden" id="hora_inicio" name="hora_inicio" value="">
                            <input type="hidden" id="hora_fin" name="hora_fin" value="">
                            <span class="form-text" id="info-horario" style="display: none;">
                                <i class="fa fa-clock-o"></i>
                                Horario de atencion: <span id="texto-horario"></span>
                            </span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-flag"></i>
                                Estado
                            </label>
                            <select id="estado" name="estado" class="form-control">
                                <option value="PENDIENTE" {% if turno.estado == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
                                <option value="CONFIRMADO" {% if turno.estado == 'CONFIRMADO' %}selected{% endif %}>Confirmado</option>
                                <option value="EN_CURSO" {% if turno.estado == 'EN_CURSO' %}selected{% endif %}>En Curso</option>
                                <option value="COMPLETADO" {% if turno.estado == 'COMPLETADO' %}selected{% endif %}>Completado</option>
                                <option value="CANCELADO" {% if turno.estado == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                                <option value="NO_ASISTIO" {% if turno.estado == 'NO_ASISTIO' %}selected{% endif %}>No Asistio</option>
                            </select>
                        </div>
                    </div>
                    {% else %}
                    <!-- MODO CREACION: Solo campos para seleccionar -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-calendar"></i>
                                Fecha <span class="required">*</span>
                            </label>
                            <input type="text" id="fecha" name="fecha" class="form-control" required
                                   placeholder="Seleccione una fecha" disabled>
                            <span class="form-text" id="info-dias-atencion" style="display: none;">
                                <i class="fa fa-calendar-check-o"></i>
                                <span id="texto-dias-atencion"></span>
                            </span>
                            <span class="form-text" id="help-fecha"><i class="fa fa-info-circle"></i> Seleccione un tipo de tramite primero</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-clock-o"></i>
                                Horario <span class="required">*</span>
                            </label>
                            <select id="horario_turno" class="form-control select2" disabled>
                                <option value="">Seleccione una fecha primero</option>
                            </select>
                            <input type="hidden" id="hora_inicio" name="hora_inicio" value="">
                            <input type="hidden" id="hora_fin" name="hora_fin" value="">
                            <span class="form-text" id="info-horario" style="display: none;">
                                <i class="fa fa-clock-o"></i>
                                Horario de atencion: <span id="texto-horario"></span>
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-flag"></i>
                                Estado
                            </label>
                            <div class="readonly-value">
                                <i class="fa fa-circle me-2" style="color: #fbbf24; font-size: 0.6rem;"></i>
                                Pendiente
                            </div>
                            <input type="hidden" id="estado" name="estado" value="PENDIENTE">
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- SECCION: OBSERVACIONES -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fa fa-comment"></i>
                    </div>
                    <div>
                        <h6 class="section-title">Observaciones</h6>
                        <p class="section-subtitle">Notas o informacion adicional</p>
                    </div>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <textarea id="observaciones" name="observaciones" class="form-control" rows="3"
                                  placeholder="Ingrese observaciones o notas adicionales sobre el turno...">{% if turno %}{{ turno.observaciones }}{% endif %}</textarea>
                    </div>
                </div>
            </div>

            <!-- SECCION: NOTIFICACIONES (solo en edicion) -->
            {% if turno %}
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fa fa-bell"></i>
                    </div>
                    <div>
                        <h6 class="section-title">Notificaciones</h6>
                        <p class="section-subtitle">Estado de envio de notificaciones</p>
                    </div>
                </div>
                <div class="section-body">
                    <div class="checkbox-group">
                        <div class="checkbox-item {% if turno.email_enviado %}checked{% endif %}">
                            <input type="checkbox" id="email_enviado" name="email_enviado" {% if turno.email_enviado %}checked{% endif %}>
                            <label for="email_enviado">
                                <i class="fa fa-envelope text-info"></i>
                                Email de confirmacion
                            </label>
                        </div>
                        <div class="checkbox-item {% if turno.whatsapp_enviado %}checked{% endif %}">
                            <input type="checkbox" id="whatsapp_enviado" name="whatsapp_enviado" {% if turno.whatsapp_enviado %}checked{% endif %}>
                            <label for="whatsapp_enviado">
                                <i class="fa fa-whatsapp text-success"></i>
                                WhatsApp enviado
                            </label>
                        </div>
                        <div class="checkbox-item {% if turno.recordatorio_enviado %}checked{% endif %}">
                            <input type="checkbox" id="recordatorio_enviado" name="recordatorio_enviado" {% if turno.recordatorio_enviado %}checked{% endif %}>
                            <label for="recordatorio_enviado">
                                <i class="fa fa-bell text-warning"></i>
                                Recordatorio enviado
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="turno-form-footer">
            <button type="button" class="btn-cancel" onclick="$('#modal-lg').modal('hide');">
                <i class="fa fa-times"></i> Cancelar
            </button>
            <button type="submit" class="btn-submit">
                <i class="fa fa-save"></i> Guardar Turno
            </button>
        </div>
    </form>
</div>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<script>
// Cargar Select2
cargarSelect2("#modal-lg");

// Toggle de checkboxes
$(".checkbox-item input[type='checkbox']").on("change", function() {
    $(this).closest(".checkbox-item").toggleClass("checked", this.checked);
});

// ============================================
// Variables de configuracion
// ============================================
var tallerConfig = null;
var tipoTramiteConfig = null;
var fechaPicker = null;

// Mapeo de dias en espanol
var diasSemana = {
    0: 'domingo',
    1: 'lunes',
    2: 'martes',
    3: 'miercoles',
    4: 'jueves',
    5: 'viernes',
    6: 'sabado'
};

var diasNumero = {
    'domingo': 0,
    'lunes': 1,
    'martes': 2,
    'miercoles': 3,
    'jueves': 4,
    'viernes': 5,
    'sabado': 6
};

var diasNombres = {
    'lunes': 'Lun',
    'martes': 'Mar',
    'miercoles': 'Mie',
    'jueves': 'Jue',
    'viernes': 'Vie',
    'sabado': 'Sab',
    'domingo': 'Dom'
};

// ============================================
// Inicializar Flatpickr
// ============================================
function inicializarFlatpickr() {
    if (fechaPicker) {
        fechaPicker.destroy();
        fechaPicker = null;
    }

    var fechaMinima = new Date();
    fechaMinima.setDate(fechaMinima.getDate() + 1);

    var fechaMaxima = new Date();
    fechaMaxima.setDate(fechaMaxima.getDate() + 60);

    // Opciones base de Flatpickr
    var fpOptions = {
        dateFormat: "Y-m-d",
        minDate: fechaMinima,
        maxDate: fechaMaxima,
        disableMobile: true,
        allowInput: false,
        disable: [],
        onChange: function(selectedDates, dateStr, instance) {
            if (selectedDates.length > 0) {
                $("#fecha").trigger("change");
            }
        }
    };

    // Usar locale espaÃ±ol solo si esta disponible
    if (flatpickr.l10ns && flatpickr.l10ns.es) {
        fpOptions.locale = "es";
    }

    fechaPicker = flatpickr("#fecha", fpOptions);
}

// ============================================
// Actualizar fechas deshabilitadas en Flatpickr
// ============================================
function actualizarFechasDeshabilitadas() {
    if (!fechaPicker || !tallerConfig) return;

    var disabledDates = [];

    // Deshabilitar dias de la semana no laborables
    if (tallerConfig.dias_atencion) {
        var diasNoLaborables = [];
        for (var dia in diasNumero) {
            if (!tallerConfig.dias_atencion[dia]) {
                diasNoLaborables.push(diasNumero[dia]);
            }
        }

        if (diasNoLaborables.length > 0) {
            disabledDates.push(function(date) {
                return diasNoLaborables.indexOf(date.getDay()) !== -1;
            });
        }
    }

    // Agregar fechas no laborables especificas (feriados, etc.)
    if (tallerConfig.fechas_no_laborables && tallerConfig.fechas_no_laborables.length > 0) {
        tallerConfig.fechas_no_laborables.forEach(function(fecha) {
            var fechaNormalizada = fecha;
            if (typeof fecha === 'object' && fecha !== null) {
                fechaNormalizada = new Date(fecha).toISOString().split('T')[0];
            } else if (typeof fecha === 'string') {
                fechaNormalizada = fecha.substring(0, 10);
            }
            disabledDates.push(fechaNormalizada);
        });
    }

    fechaPicker.set('disable', disabledDates);
}

// ============================================
// Funcion auxiliar para resetear campos en cascada
// ============================================
function resetearCamposCascada(desde) {
    if (desde === 'taller' || desde === 'all') {
        $("#tipo_vehiculo").val('').prop('disabled', true);
        $("#tipo_vehiculo").html('<option value="">Primero seleccione un taller</option>');
        $("#help-tipo-tramite").show();
    }
    if (desde === 'taller' || desde === 'tipo' || desde === 'all') {
        if (fechaPicker) {
            fechaPicker.clear();
            fechaPicker.set('disable', []);
        }
        $("#fecha").val('').prop('disabled', true);
        $("#help-fecha").show();
        $("#info-dias-atencion").hide();
    }
    if (desde === 'taller' || desde === 'tipo' || desde === 'fecha' || desde === 'all') {
        $("#horario_turno").val('').prop('disabled', true);
        $("#horario_turno").html('<option value="">Seleccione una fecha primero</option>');
        $("#hora_inicio").val('');
        $("#hora_fin").val('');
        $("#info-horario").hide();
    }
}

// ============================================
// 1. Cambio de Taller
// ============================================
$("#taller").on("change", function() {
    var tallerId = $(this).val();
    tallerConfig = null;
    tipoTramiteConfig = null;

    resetearCamposCascada('taller');

    if (!tallerId) return;

    $.ajax({
        url: "{% url 'obtener_configuracion_taller' %}",
        type: "POST",
        data: {
            'taller_id': tallerId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(data) {
            if (data.success) {
                tallerConfig = data.configuracion;
            }
        }
    });

    $.ajax({
        url: "{% url 'obtener_tipos_tramite_taller' %}",
        type: "POST",
        data: {
            'taller_id': tallerId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        beforeSend: function() {
            $("#tipo_vehiculo").html('<option value="">Cargando...</option>');
        },
        success: function(data) {
            if ($("#tipo_vehiculo").hasClass("select2-hidden-accessible")) {
                $("#tipo_vehiculo").select2('destroy');
            }

            if (data.success && data.tipos_tramite && data.tipos_tramite.length > 0) {
                var html = '<option value="">Seleccione tipo de tramite</option>';
                data.tipos_tramite.forEach(function(tipo) {
                    var precioTexto = '';
                    if (tipo.precio && tipo.precio > 0) {
                        precioTexto = ' - $' + tipo.precio.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    }
                    html += '<option value="' + tipo.id + '" data-duracion="' + tipo.duracion_minutos + '" data-intervalo="' + tipo.intervalo_minutos + '">' + tipo.nombre + precioTexto + '</option>';
                });
                $("#tipo_vehiculo").html(html).prop('disabled', false);
                $("#help-tipo-tramite").hide();
            } else {
                $("#tipo_vehiculo").html('<option value="">No hay tramites configurados</option>');
            }

            cargarSelect2("#modal-lg");
        },
        error: function() {
            $("#tipo_vehiculo").html('<option value="">Error al cargar tramites</option>');
            cargarSelect2("#modal-lg");
        }
    });
});

// ============================================
// 2. Cambio de Tipo de Tramite
// ============================================
$("#tipo_vehiculo").on("change", function() {
    var tipoId = $(this).val();

    resetearCamposCascada('tipo');

    if (!tipoId) return;

    var $selected = $(this).find('option:selected');
    tipoTramiteConfig = {
        id: tipoId,
        duracion_minutos: parseInt($selected.data('duracion')) || 30,
        intervalo_minutos: parseInt($selected.data('intervalo')) || 30
    };

    $("#fecha").prop('disabled', false);
    $("#help-fecha").hide();

    inicializarFlatpickr();
    actualizarFechasDeshabilitadas();

    if (tallerConfig && tallerConfig.dias_atencion) {
        var diasActivos = [];
        for (var dia in tallerConfig.dias_atencion) {
            if (tallerConfig.dias_atencion[dia]) {
                diasActivos.push(diasNombres[dia] || dia);
            }
        }
        if (diasActivos.length > 0) {
            $("#texto-dias-atencion").text("Dias de atencion: " + diasActivos.join(", "));
            $("#info-dias-atencion").show();
        }
    }
});

// ============================================
// 3. Cambio de Fecha
// ============================================
$("#fecha").on("change", function() {
    var fecha = $(this).val();

    resetearCamposCascada('fecha');

    if (!fecha || !tallerConfig) return;

    var fechaObj = new Date(fecha + 'T12:00:00');
    var diaSemana = fechaObj.getDay();
    var diaTexto = diasSemana[diaSemana];

    if (tallerConfig.dias_atencion && !tallerConfig.dias_atencion[diaTexto]) {
        Swal.fire({
            title: "Dia no disponible",
            text: "El taller no atiende los dias " + diaTexto,
            icon: "warning"
        });
        $(this).val('');
        return;
    }

    if (tallerConfig.fechas_no_laborables && tallerConfig.fechas_no_laborables.length > 0) {
        var esFechaNoLaborable = tallerConfig.fechas_no_laborables.some(function(fechaNoLab) {
            var fechaNormalizada = fechaNoLab;
            if (typeof fechaNoLab === 'object' && fechaNoLab !== null) {
                fechaNormalizada = new Date(fechaNoLab).toISOString().split('T')[0];
            }
            return fechaNormalizada === fecha;
        });

        if (esFechaNoLaborable) {
            Swal.fire({
                title: "Fecha no disponible",
                text: "Esta fecha esta marcada como no laborable",
                icon: "warning"
            });
            $(this).val('');
            return;
        }
    }

    var tallerId = $("#taller").val();
    var tipoId = $("#tipo_vehiculo").val();
    var turnoId = $("#pk").val();

    $.ajax({
        url: "{% url 'obtener_horarios_disponibles' %}",
        type: "POST",
        data: {
            'taller_id': tallerId,
            'tipo_vehiculo_id': tipoId,
            'fecha': fecha,
            'turno_id': turnoId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        beforeSend: function() {
            if ($("#horario_turno").hasClass("select2-hidden-accessible")) {
                $("#horario_turno").select2('destroy');
            }
            $("#horario_turno").html('<option value="">Cargando horarios...</option>');
        },
        success: function(data) {
            if (data.success && data.horarios && data.horarios.length > 0) {
                var html = '<option value="">Seleccione un horario</option>';
                var hayDisponibles = false;

                data.horarios.forEach(function(slot) {
                    var disponibilidadText = '';
                    if (slot.capacidad > 1) {
                        disponibilidadText = ' (' + (slot.capacidad - slot.ocupados) + '/' + slot.capacidad + ' disp.)';
                    }

                    if (slot.disponible) {
                        hayDisponibles = true;
                        html += '<option value="' + slot.hora_inicio + '|' + slot.hora_fin + '">' +
                                slot.hora_inicio + ' - ' + slot.hora_fin + disponibilidadText +
                                '</option>';
                    } else {
                        html += '<option value="" disabled style="color: #999;">' +
                                slot.hora_inicio + ' - ' + slot.hora_fin + ' (Ocupado)' +
                                '</option>';
                    }
                });

                if (!hayDisponibles) {
                    html = '<option value="">No hay horarios disponibles</option>';
                }

                $("#horario_turno").html(html).prop('disabled', false);

                if (tallerConfig.horario_apertura && tallerConfig.horario_cierre) {
                    $("#texto-horario").text(tallerConfig.horario_apertura + " a " + tallerConfig.horario_cierre + " hs");
                    $("#info-horario").show();
                }
            } else {
                $("#horario_turno").html('<option value="">No hay horarios disponibles</option>');
            }

            cargarSelect2("#modal-lg");
        },
        error: function() {
            $("#horario_turno").html('<option value="">Error al cargar horarios</option>');
            cargarSelect2("#modal-lg");
        }
    });
});

// ============================================
// 4. Cambio de Horario
// ============================================
$("#horario_turno").on("change", function() {
    var valor = $(this).val();

    if (!valor) {
        $("#hora_inicio").val('');
        $("#hora_fin").val('');
        return;
    }

    var partes = valor.split('|');
    $("#hora_inicio").val(partes[0]);
    $("#hora_fin").val(partes[1]);
});

// ============================================
// Cargar vehiculos del cliente
// ============================================
$("#cliente").on("change", function() {
    var clienteId = $(this).val();
    var $vehiculoSelect = $("#vehiculo");

    if ($vehiculoSelect.hasClass("select2-hidden-accessible")) {
        $vehiculoSelect.select2('destroy');
    }

    $vehiculoSelect.empty().append('<option value="">Cargando...</option>');

    if (!clienteId) {
        $vehiculoSelect.empty().append('<option value="">Seleccione un vehiculo</option>');
        cargarSelect2("#modal-lg");
        return;
    }

    $.ajax({
        url: "{% url 'obtener_vehiculos_cliente' %}",
        type: "POST",
        data: {
            'cliente_id': clienteId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(data) {
            $vehiculoSelect.empty().append('<option value="">Seleccione un vehiculo</option>');

            if (data.vehiculos && data.vehiculos.length > 0) {
                data.vehiculos.forEach(function(v) {
                    var texto = v.dominio;
                    if (v.marca) texto += ' - ' + v.marca;
                    if (v.modelo) texto += ' ' + v.modelo;
                    if (v.tiene_gnc) texto += ' (GNC)';
                    $vehiculoSelect.append('<option value="' + v.id + '">' + texto + '</option>');
                });
            } else {
                $vehiculoSelect.append('<option value="" disabled>No hay vehiculos registrados</option>');
            }

            cargarSelect2("#modal-lg");
        },
        error: function() {
            $vehiculoSelect.empty().append('<option value="">Error al cargar vehiculos</option>');
            cargarSelect2("#modal-lg");
        }
    });
});

// ============================================
// Validacion del formulario
// ============================================
$(document).on("submit", "#turno_form", function(e) {
    e.preventDefault();

    var cliente = $("#cliente").val();
    var vehiculo = $("#vehiculo").val();
    var taller = $("#taller").val();
    var tipoVehiculo = $("#tipo_vehiculo").val();
    var fecha = $("#fecha").val();
    var horaInicio = $("#hora_inicio").val();
    var horaFin = $("#hora_fin").val();

    if (!cliente || !vehiculo || !taller || !tipoVehiculo || !fecha || !horaInicio || !horaFin) {
        Swal.fire({
            title: "Campos obligatorios",
            text: "Debe completar todos los campos requeridos",
            icon: "warning"
        });
        return false;
    }

    if (horaFin <= horaInicio) {
        Swal.fire({
            title: "Error en horarios",
            text: "La hora de finalizacion debe ser mayor a la hora de inicio",
            icon: "error"
        });
        return false;
    }

    var formData = new FormData(this);

    $.ajax({
        url: "{% url 'gestion_turnos_guardar' %}",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        beforeSend: function() {
            Swal.fire({
                title: "Guardando...",
                html: '<i class="fa fa-spinner fa-spin fa-2x"></i>',
                showConfirmButton: false,
                allowOutsideClick: false
            });
        },
        success: function(data) {
            Swal.close();
            if (data.success) {
                Swal.fire({
                    title: 'Guardado!',
                    text: data.message || 'El turno fue guardado correctamente',
                    icon: 'success'
                }).then(function() {
                    $("#modal-lg").modal('hide');
                    cargarTabla();
                });
            } else {
                Swal.fire({
                    title: 'Error',
                    text: data.error || 'No se pudo guardar el turno',
                    icon: 'error'
                });
            }
        },
        error: function() {
            Swal.fire({
                title: 'Error',
                text: 'Error al guardar el turno',
                icon: 'error'
            });
        }
    });
});

// ============================================
// Modal Agregar Cliente
// ============================================
$(".btn-agregar-cliente").on("click", function() {
    var modalHtml = `
    <div class="modal fade" id="modal-nuevo-cliente" tabindex="-1" role="dialog" data-backdrop="static">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="turno-form-header">
                    <h5><i class="fa fa-user-plus"></i> Nuevo Cliente</h5>
                    <button type="button" class="close-btn" data-dismiss="modal"><i class="fa fa-times"></i></button>
                </div>
                <form id="form-nuevo-cliente">
                    <div class="turno-form-body" style="max-height: 60vh;">
                        <div class="form-section">
                            <div class="section-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label"><i class="fa fa-id-card"></i> DNI <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="nuevo_cliente_dni" name="dni" maxlength="8" required placeholder="12345678">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label"><i class="fa fa-user"></i> Nombre <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="nuevo_cliente_nombre" name="nombre" required placeholder="Juan">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label"><i class="fa fa-user"></i> Apellido <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="nuevo_cliente_apellido" name="apellido" required placeholder="Perez">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label"><i class="fa fa-envelope"></i> Email</label>
                                        <input type="email" class="form-control" id="nuevo_cliente_email" name="email" placeholder="correo@ejemplo.com">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label"><i class="fa fa-phone"></i> Celular</label>
                                        <input type="text" class="form-control" id="nuevo_cliente_celular" name="celular" placeholder="3764123456">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label class="form-label"><i class="fa fa-map-marker"></i> Domicilio</label>
                                        <input type="text" class="form-control" id="nuevo_cliente_domicilio" name="domicilio" placeholder="Calle 123, Ciudad">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="turno-form-footer">
                        <button type="button" class="btn-cancel" data-dismiss="modal"><i class="fa fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-submit"><i class="fa fa-save"></i> Guardar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>`;

    $("#modal-nuevo-cliente").remove();
    $("body").append(modalHtml);
    $("#modal-nuevo-cliente").modal("show");

    $("#form-nuevo-cliente").off("submit").on("submit", function(e) {
        e.preventDefault();

        var dni = $("#nuevo_cliente_dni").val().trim();
        var nombre = $("#nuevo_cliente_nombre").val().trim();
        var apellido = $("#nuevo_cliente_apellido").val().trim();

        if (!dni || !nombre || !apellido) {
            Swal.fire("Error", "DNI, Nombre y Apellido son obligatorios", "error");
            return;
        }

        $.ajax({
            url: "{% url 'guardar_cliente_rapido' %}",
            type: "POST",
            data: {
                'dni': dni,
                'nombre': nombre,
                'apellido': apellido,
                'email': $("#nuevo_cliente_email").val(),
                'celular': $("#nuevo_cliente_celular").val(),
                'domicilio': $("#nuevo_cliente_domicilio").val(),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            beforeSend: function() {
                Swal.fire({
                    title: "Guardando...",
                    html: '<i class="fa fa-spinner fa-spin fa-2x"></i>',
                    showConfirmButton: false,
                    allowOutsideClick: false
                });
            },
            success: function(data) {
                Swal.close();
                if (data.success) {
                    var newOption = new Option(data.cliente.dni + ' - ' + data.cliente.nombre + ' ' + data.cliente.apellido, data.cliente.id, true, true);
                    $("#cliente").append(newOption).trigger('change');
                    $("#modal-nuevo-cliente").modal("hide");
                    Swal.fire({
                        title: "Cliente Creado",
                        text: "El cliente fue agregado correctamente",
                        icon: "success",
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire("Error", data.error || "No se pudo crear el cliente", "error");
                }
            },
            error: function() {
                Swal.fire("Error", "Error al guardar el cliente", "error");
            }
        });
    });
});

// ============================================
// Modal Agregar Vehiculo
// ============================================
$(".btn-agregar-vehiculo").on("click", function() {
    var clienteId = $("#cliente").val();

    if (!clienteId) {
        Swal.fire({
            title: "Seleccione un cliente",
            text: "Debe seleccionar un cliente antes de agregar un vehiculo",
            icon: "warning"
        });
        return;
    }

    var modalHtml = `
    <div class="modal fade" id="modal-nuevo-vehiculo" tabindex="-1" role="dialog" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="turno-form-header">
                    <h5><i class="fa fa-car"></i> Nuevo Vehiculo</h5>
                    <button type="button" class="close-btn" data-dismiss="modal"><i class="fa fa-times"></i></button>
                </div>
                <form id="form-nuevo-vehiculo">
                    <input type="hidden" id="nuevo_vehiculo_cliente_id" value="${clienteId}">
                    <div class="turno-form-body" style="max-height: 60vh;">
                        <div class="form-section">
                            <div class="section-body">
                                <div class="form-row">
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label class="form-label"><i class="fa fa-hashtag"></i> Dominio (Patente) <span class="required">*</span></label>
                                        <input type="text" class="form-control text-uppercase" id="nuevo_vehiculo_dominio" name="dominio" maxlength="10" required placeholder="ABC123 o AB123CD" style="font-size: 1.25rem; font-weight: 600; letter-spacing: 2px; text-align: center;">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label"><i class="fa fa-industry"></i> Marca</label>
                                        <input type="text" class="form-control" id="nuevo_vehiculo_marca" name="marca" placeholder="Toyota">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label"><i class="fa fa-car"></i> Modelo</label>
                                        <input type="text" class="form-control" id="nuevo_vehiculo_modelo" name="modelo" placeholder="Corolla">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="nuevo_vehiculo_gnc" name="tiene_gnc">
                                            <label for="nuevo_vehiculo_gnc">
                                                <i class="fa fa-fire text-warning"></i>
                                                Tiene GNC instalado
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="turno-form-footer">
                        <button type="button" class="btn-cancel" data-dismiss="modal"><i class="fa fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-submit"><i class="fa fa-save"></i> Guardar Vehiculo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>`;

    $("#modal-nuevo-vehiculo").remove();
    $("body").append(modalHtml);
    $("#modal-nuevo-vehiculo").modal("show");

    $("#nuevo_vehiculo_dominio").on("input", function() {
        $(this).val($(this).val().toUpperCase());
    });

    $("#form-nuevo-vehiculo").off("submit").on("submit", function(e) {
        e.preventDefault();

        var dominio = $("#nuevo_vehiculo_dominio").val().trim().toUpperCase();

        if (!dominio) {
            Swal.fire("Error", "El Dominio es obligatorio", "error");
            return;
        }

        $.ajax({
            url: "{% url 'guardar_vehiculo_rapido' %}",
            type: "POST",
            data: {
                'cliente_id': $("#nuevo_vehiculo_cliente_id").val(),
                'dominio': dominio,
                'marca': $("#nuevo_vehiculo_marca").val(),
                'modelo': $("#nuevo_vehiculo_modelo").val(),
                'tiene_gnc': $("#nuevo_vehiculo_gnc").is(":checked") ? 'on' : '',
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            beforeSend: function() {
                Swal.fire({
                    title: "Guardando...",
                    html: '<i class="fa fa-spinner fa-spin fa-2x"></i>',
                    showConfirmButton: false,
                    allowOutsideClick: false
                });
            },
            success: function(data) {
                Swal.close();
                if (data.success) {
                    var displayText = data.vehiculo.dominio;
                    if (data.vehiculo.marca) displayText += ' - ' + data.vehiculo.marca;
                    if (data.vehiculo.modelo) displayText += ' ' + data.vehiculo.modelo;

                    var newOption = new Option(displayText, data.vehiculo.id, true, true);
                    $("#vehiculo").append(newOption).trigger('change');

                    $("#modal-nuevo-vehiculo").modal("hide");

                    Swal.fire({
                        title: "Vehiculo Creado",
                        text: "El vehiculo fue agregado correctamente",
                        icon: "success",
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire("Error", data.error || "No se pudo crear el vehiculo", "error");
                }
            },
            error: function() {
                Swal.fire("Error", "Error al guardar el vehiculo", "error");
            }
        });
    });
});

// ============================================
// Inicializacion para edicion de turnos existentes
// ============================================
{% if turno %}
setTimeout(function() {
    var tallerId = $("#taller").val();
    var tipoVehiculoId = $("#tipo_vehiculo").val();

    if (tallerId) {
        $.ajax({
            url: "{% url 'obtener_configuracion_taller' %}",
            type: "POST",
            data: {
                'taller_id': tallerId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(data) {
                if (data.success) {
                    tallerConfig = data.configuracion;

                    // Inicializar Flatpickr normalmente
                    inicializarFlatpickr();

                    // Aplicar restricciones de fechas
                    actualizarFechasDeshabilitadas();

                    // Mostrar informacion de dias de atencion
                    if (tallerConfig.dias_atencion) {
                        var diasTexto = [];
                        for (var dia in diasNombres) {
                            if (tallerConfig.dias_atencion[dia]) {
                                diasTexto.push(diasNombres[dia]);
                            }
                        }
                        if (diasTexto.length > 0) {
                            $("#texto-dias-atencion").text("Dias disponibles: " + diasTexto.join(', '));
                            $("#info-dias-atencion").show();
                        }
                    }

                    // Habilitar el campo de fecha
                    $("#fecha").prop('disabled', false);
                }
            }
        });
    }
}, 100);
{% endif %}
</script>
