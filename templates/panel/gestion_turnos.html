{% extends "panel/base.html" %}
{% block extraCss %}
<style>
    /* Prevenir overflow horizontal en la página */
    html, body {
        overflow-x: hidden;
        max-width: 100%;
    }

    .card-body {
        overflow-x: hidden;
    }

    .container-fluid {
        overflow-x: hidden;
        max-width: 100%;
    }

    /* Estilos para columna Estado en tabla de turnos */
    .badge-estado {
        display: inline-block;
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 600;
        border-radius: 4px;
        line-height: 1.3;
        text-align: center;
        white-space: normal;
        word-wrap: break-word;
    }

    .badge-pendiente {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-confirmado {
        background-color: #d4edda;
        color: #155724;
    }

    .badge-en-curso {
        background-color: #cce5ff;
        color: #004085;
    }

    .badge-completado {
        background-color: #28a745;
        color: white;
    }

    .badge-cancelado {
        background-color: #f8d7da;
        color: #721c24;
    }

    .badge-no-asistio {
        background-color: #6c757d;
        color: white;
    }

    /* Estilo para código de turno */
    #data_table_ajax .turno-codigo {
        font-weight: 600;
        color: var(--theme-primary);
    }

    /* Ajustar ancho de columnas de fecha */
    #data_table_ajax th:nth-child(5),
    #data_table_ajax th:nth-child(6),
    #data_table_ajax td:nth-child(5),
    #data_table_ajax td:nth-child(6) {
        white-space: nowrap;
    }

    /* Estilos para la sección de filtros colapsable */
    .filtros-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .btn-toggle-filtros {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background-color: var(--theme-primary);
        border: 1px solid var(--theme-primary);
        color: white;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-toggle-filtros:hover {
        background-color: var(--theme-primary-dark);
        border-color: var(--theme-primary-dark);
    }

    .btn-toggle-filtros i {
        transition: transform 0.3s ease;
    }

    .btn-toggle-filtros.collapsed i.fa-chevron-down {
        transform: rotate(0deg);
    }

    .btn-toggle-filtros:not(.collapsed) i.fa-chevron-down {
        transform: rotate(180deg);
    }

    .filtros-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background-color: #e6603a;
        color: white;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 4px;
    }

    .filtros-badge.hidden {
        display: none;
    }

    .filtros-container {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .filtros-container.collapsed {
        display: none;
    }

    .filtros-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        width: 100%;
        box-sizing: border-box;
    }

    .filtro-item {
        box-sizing: border-box;
    }

    .filtro-item label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }

    .filtro-item .form-control,
    .filtro-item .select2-container {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box;
    }

    .filtro-item .form-control {
        font-size: 14px;
        height: 38px;
        border-radius: 4px;
    }

    .filtros-acciones {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        padding-bottom: 2px;
        flex-shrink: 0;
    }

    .btn-filtrar {
        background-color: var(--theme-primary);
        border-color: var(--theme-primary);
        color: white;
        width: 38px;
        height: 38px;
        padding: 0;
        font-size: 15px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-filtrar:hover {
        background-color: var(--theme-primary-dark);
        border-color: var(--theme-primary-dark);
        color: white;
    }

    .btn-limpiar {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
        width: 38px;
        height: 38px;
        padding: 0;
        font-size: 15px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-limpiar:hover {
        background-color: #5a6268;
        border-color: #5a6268;
        color: white;
    }

    /* Ajuste para fechas */
    .filtro-fechas {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .filtro-fechas .filtro-item {
        flex: 1 1 120px;
        min-width: 120px;
        max-width: 150px;
    }

    /* Botones de acción en tabla */
    .btn-accion {
        padding: 5px 10px;
        margin: 2px;
        font-size: 12px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .btn-accion i {
        font-size: 13px;
    }

    /* Contenedor de acciones - 3 botones por fila */
    .acciones-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
        min-width: 140px;
    }

    /* Estilo único para todos los botones con color del tema */
    .btn-accion {
        background-color: #13304D;
        border-color: #13304D;
        color: white;
    }

    .btn-accion:hover {
        background-color: #0d2236;
        border-color: #0d2236;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(19, 48, 77, 0.3);
    }

    /* ============================================= */
    /* Vista Desktop (tabla)                         */
    /* ============================================= */
    .vista-desktop {
        display: block;
    }

    /* ============================================= */
    /* Vista Móvil (cards)                           */
    /* ============================================= */
    .vista-mobile {
        display: none;
    }

    /* Header móvil */
    .mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .mobile-header .btn-nuevo {
        background-color: var(--theme-primary);
        border-color: var(--theme-primary);
        color: white;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .mobile-header .btn-nuevo:hover {
        background-color: var(--theme-primary-dark);
        border-color: var(--theme-primary-dark);
    }

    .mobile-header .turnos-count {
        font-size: 13px;
        color: #6c757d;
        font-weight: 500;
    }

    /* Cards container */
    .turnos-cards-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* Card individual de turno */
    .turno-card {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        transition: box-shadow 0.2s ease;
        overflow: visible;
    }

    .turno-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    /* Borde izquierdo con color del tema */
    .turno-card {
        border-left: 4px solid var(--theme-primary);
    }

    /* Header de la card */
    .turno-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 12px 15px;
        background: #fafafa;
        border-bottom: 1px solid #f0f0f0;
    }

    .turno-card-codigo {
        font-size: 15px;
        font-weight: 700;
        color: var(--theme-primary);
        letter-spacing: 0.5px;
    }

    .turno-card-estado {
        flex-shrink: 0;
    }

    /* Body de la card */
    .turno-card-body {
        padding: 15px;
    }

    .turno-card-cliente {
        font-size: 15px;
        font-weight: 600;
        color: #212529;
        margin-bottom: 2px;
    }

    .turno-card-dni {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 12px;
    }

    /* Info grid de la card */
    .turno-card-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 15px;
    }

    .turno-card-info-item {
        display: flex;
        flex-direction: column;
    }

    .turno-card-info-item .label {
        font-size: 10px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
        font-weight: 500;
    }

    .turno-card-info-item .value {
        font-size: 13px;
        color: #212529;
        font-weight: 500;
    }

    .turno-card-info-item .value.dominio {
        font-weight: 700;
        color: #333;
    }

    /* Footer de la card con acciones */
    .turno-card-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding: 12px 15px;
        background: #fafafa;
        border-top: 1px solid #f0f0f0;
        overflow: visible;
        position: relative;
    }

    .turno-card-footer .btn {
        padding: 8px 12px;
        font-size: 13px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .turno-card-footer .btn-ver {
        background-color: var(--theme-primary);
        border-color: var(--theme-primary);
        color: white;
    }

    .turno-card-footer .btn-ver:hover {
        background-color: var(--theme-primary-dark);
    }

    .turno-card-footer .btn-acciones {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #495057;
    }

    .turno-card-footer .btn-acciones:hover {
        background-color: #e9ecef;
    }

    /* Loading y empty state para cards */
    .turnos-cards-loading {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .turnos-cards-loading i {
        font-size: 32px;
        margin-bottom: 10px;
        color: var(--theme-primary);
    }

    .turnos-cards-empty {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .turnos-cards-empty i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #dee2e6;
    }

    /* Paginación móvil */
    .mobile-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .mobile-pagination .btn-page {
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #495057;
        font-size: 14px;
    }

    .mobile-pagination .btn-page:hover {
        background: #e9ecef;
    }

    .mobile-pagination .btn-page.active {
        background: var(--theme-primary);
        border-color: var(--theme-primary);
        color: white;
    }

    .mobile-pagination .btn-page:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .mobile-pagination .page-info {
        font-size: 13px;
        color: #6c757d;
    }

    /* Dropdown de acciones en cards */
    .dropdown-acciones .dropdown-toggle::after {
        display: none; /* Ocultar la flechita del dropdown */
    }

    .dropdown-acciones .dropdown-menu {
        min-width: 160px;
        padding: 8px 0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        position: absolute;
    }

    .dropdown-acciones.show .dropdown-menu {
        display: block;
    }

    /* Asegurar que el card con dropdown abierto tenga z-index alto */
    .turno-card {
        position: relative;
    }

    .turno-card .dropdown.show {
        z-index: 9999;
    }

    .dropdown-acciones .dropdown-item {
        padding: 8px 15px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .dropdown-acciones .dropdown-item i {
        width: 16px;
        text-align: center;
    }

    .dropdown-acciones .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    .dropdown-acciones .dropdown-divider {
        margin: 5px 0;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .filtros-row {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 992px) {
        .filtros-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .vista-desktop {
            display: none !important;
        }

        .vista-mobile {
            display: block !important;
        }

        /* Ocultar botones de DataTables en móvil */
        .dt-buttons {
            display: none !important;
        }
    }

    @media (max-width: 576px) {
        .filtros-row {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .filtros-container {
            padding: 12px;
        }

        .btn-toggle-filtros {
            width: 100%;
            justify-content: center;
        }

        .turno-card-info {
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .turno-card-footer {
            flex-direction: column;
        }

        .turno-card-footer .btn {
            width: 100%;
            justify-content: center;
        }
    }

    /* Botón flotante volver arriba */
    .btn-volver-arriba {
        position: fixed;
        right: 20px;
        bottom: 90px;
        width: 45px;
        height: 45px;
        background-color: var(--theme-primary);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 999;
    }

    .btn-volver-arriba.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .btn-volver-arriba:hover {
        background-color: var(--theme-primary-dark);
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    @media (max-width: 768px) {
        .btn-volver-arriba {
            right: 15px;
            bottom: 85px;
            width: 42px;
            height: 42px;
            font-size: 16px;
        }
    }
</style>
{% endblock %}

{% block main %}
{% load static %}

<div id="main-content" class="profilepage_2 blog-page">
    <div class="container-fluid">
        <div class="block-header">
            <div class="row g-3">
                <div class="col-lg-5 col-md-8 col-sm-12">
                    <h2><a href="javascript:void(0);" class="btn btn-xs btn-link btn-toggle-fullwidth"><i class="fa fa-arrow-right"></i></a>
                        {{ titulo }}</h2>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'panel_home' %}"><i class="icon-home text-orange"></i></a></li>
                        <li class="breadcrumb-item active">{{ titulo }}</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row clearfix">
            <div class="col-lg-12 col-md-12">
                <div class="card">
                    <div class="card-body">
                        <!-- Botón para mostrar/ocultar filtros -->
                        <div class="filtros-header">
                            <button type="button" class="btn-toggle-filtros collapsed" id="btn-toggle-filtros">
                                <i class="fa fa-filter"></i>
                                <span>Filtros</span>
                                <span class="filtros-badge hidden" id="filtros-badge">0</span>
                                <i class="fa fa-chevron-down"></i>
                            </button>
                        </div>

                        <!-- Filtros Avanzados (colapsable) -->
                        <div class="filtros-container collapsed" id="filtros-container">
                            <div class="filtros-row">
                                <!-- Código de Turno -->
                                <div class="filtro-item">
                                    <label for="filtro-codigo">Código</label>
                                    <input type="text" class="form-control" id="filtro-codigo" placeholder="TRN-...">
                                </div>

                                <!-- Estado -->
                                <div class="filtro-item">
                                    <label for="filtro-estado">Estado</label>
                                    <select class="form-control" id="filtro-estado">
                                        <option value="">Todos</option>
                                        <option value="PENDIENTE">Pendiente</option>
                                        <option value="CONFIRMADO">Confirmado</option>
                                        <option value="EN_CURSO">En Curso</option>
                                        <option value="COMPLETADO">Completado</option>
                                        <option value="CANCELADO">Cancelado</option>
                                        <option value="NO_ASISTIO">No Asistió</option>
                                    </select>
                                </div>

                                <!-- Taller -->
                                <div class="filtro-item">
                                    <label for="filtro-taller">Taller</label>
                                    <select class="form-control" id="filtro-taller">
                                        <option value="">Todos</option>
                                        {% for taller in talleres %}
                                        <option value="{{ taller.id }}">{{ taller.get_nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Cliente (DNI o Nombre) -->
                                <div class="filtro-item">
                                    <label for="filtro-cliente">Cliente</label>
                                    <input type="text" class="form-control" id="filtro-cliente" placeholder="DNI o nombre...">
                                </div>

                                <!-- Dominio -->
                                <div class="filtro-item">
                                    <label for="filtro-dominio">Dominio</label>
                                    <input type="text" class="form-control" id="filtro-dominio" placeholder="ABC123...">
                                </div>

                                <!-- Fechas -->
                                <div class="filtro-fechas">
                                    <div class="filtro-item">
                                        <label for="filtro-fecha-desde">Fecha Desde</label>
                                        <input type="date" class="form-control" id="filtro-fecha-desde">
                                    </div>
                                    <div class="filtro-item">
                                        <label for="filtro-fecha-hasta">Fecha Hasta</label>
                                        <input type="date" class="form-control" id="filtro-fecha-hasta">
                                    </div>
                                </div>

                                <!-- Botones de acción -->
                                <div class="filtros-acciones">
                                    <button type="button" class="btn btn-filtrar" id="btn-aplicar-filtros" title="Filtrar">
                                        <i class="fa fa-search"></i>
                                    </button>
                                    <button type="button" class="btn btn-limpiar" id="btn-limpiar-filtros" title="Limpiar">
                                        <i class="fa fa-eraser"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Vista Desktop (Tabla) -->
                        <div class="vista-desktop">
                            <div class="row container-table">
                                <div class="table-responsive col-lg-12 container-table">
                                    <table id="data_table_ajax" class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Código</th>
                                                <th>Cliente</th>
                                                <th>Vehículo</th>
                                                <th>Taller</th>
                                                <th>Fecha</th>
                                                <th>Hora</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Vista Móvil (Cards) -->
                        <div class="vista-mobile">
                            <div class="mobile-header">
                                <button type="button" class="btn btn-nuevo" onclick="gestionTurno('')">
                                    <i class="fa fa-plus"></i> Nuevo Turno
                                </button>
                                <span class="turnos-count" id="turnos-count"></span>
                            </div>

                            <div id="turnos-cards-container" class="turnos-cards-container">
                                <div class="turnos-cards-loading">
                                    <i class="fa fa-spinner fa-spin"></i>
                                    <p>Cargando turnos...</p>
                                </div>
                            </div>

                            <div class="mobile-pagination" id="mobile-pagination" style="display: none;">
                                <button type="button" class="btn btn-page" id="btn-prev-page" disabled>
                                    <i class="fa fa-chevron-left"></i>
                                </button>
                                <span class="page-info" id="page-info">1 de 1</span>
                                <button type="button" class="btn btn-page" id="btn-next-page" disabled>
                                    <i class="fa fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Botón flotante volver arriba -->
<button type="button" class="btn-volver-arriba" id="btn-volver-arriba" title="Volver arriba">
    <i class="fa fa-chevron-up"></i>
</button>

<!-- Modal para Turnero (iframe) -->
<div class="modal fade" id="modal-turnero" tabindex="-1" aria-labelledby="modal-turnero-label" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 95%; height: 90vh;">
        <div class="modal-content" style="height: 90vh;">
            <div class="modal-header" style="padding: 10px 20px; background: var(--theme-primary); color: white;">
                <h5 class="modal-title" id="modal-turnero-label">
                    <i class="fa fa-plus-circle me-2"></i> Nuevo Turno
                </h5>
                <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Cerrar" onclick="cerrarModalTurnero()"></button>
            </div>
            <div class="modal-body p-0" style="height: calc(90vh - 60px); overflow: auto;">
                <iframe id="iframe-turnero" src="" style="width: 100%; height: 100%; border: none;" scrolling="yes"></iframe>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extraJS %}
<script>
$(document).ready(function(){
    // Cargar tabla al inicio
    cargarTabla();

    // Toggle para mostrar/ocultar filtros
    $('#btn-toggle-filtros').on('click', function(){
        var $btn = $(this);
        var $container = $('#filtros-container');

        $btn.toggleClass('collapsed');
        $container.toggleClass('collapsed');

        var $span = $btn.find('span').first();
        if ($btn.hasClass('collapsed')) {
            $span.text('Mostrar Filtros');
        } else {
            $span.text('Ocultar Filtros');
        }
    });

    // Evento para el botón Filtrar
    $('#btn-aplicar-filtros').on('click', function(){
        cargarTabla();
        actualizarBadgeFiltros();
    });

    // Evento para el botón Limpiar
    $('#btn-limpiar-filtros').on('click', function(){
        limpiarFiltros();
    });

    // Permitir filtrar con Enter en campos de texto
    $('#filtro-codigo, #filtro-cliente, #filtro-dominio').on('keypress', function(e){
        if (e.which === 13) {
            cargarTabla();
            actualizarBadgeFiltros();
        }
    });

    // Botón volver arriba
    var $btnVolverArriba = $('#btn-volver-arriba');
    $(window).on('scroll', function() {
        if ($(this).scrollTop() > 300) {
            $btnVolverArriba.addClass('visible');
        } else {
            $btnVolverArriba.removeClass('visible');
        }
    });

    $btnVolverArriba.on('click', function() {
        $('html, body').animate({ scrollTop: 0 }, 400);
    });
});

// Función para contar y mostrar filtros activos
function actualizarBadgeFiltros() {
    var count = 0;

    if ($('#filtro-codigo').val().trim()) count++;
    if ($('#filtro-estado').val()) count++;
    if ($('#filtro-taller').val()) count++;
    if ($('#filtro-cliente').val().trim()) count++;
    if ($('#filtro-dominio').val().trim()) count++;
    if ($('#filtro-fecha-desde').val()) count++;
    if ($('#filtro-fecha-hasta').val()) count++;

    var $badge = $('#filtros-badge');
    if (count > 0) {
        $badge.text(count).removeClass('hidden');
    } else {
        $badge.addClass('hidden');
    }
}

// Función para limpiar todos los filtros
function limpiarFiltros() {
    $('#filtro-codigo').val('');
    $('#filtro-estado').val('');
    $('#filtro-taller').val('');
    $('#filtro-cliente').val('');
    $('#filtro-dominio').val('');
    $('#filtro-fecha-desde').val('');
    $('#filtro-fecha-hasta').val('');

    actualizarBadgeFiltros();
    cargarTabla();
}

var table;

function cargarTabla(){
    $('#data_table_ajax').dataTable().fnClearTable();
    $('#data_table_ajax').dataTable().fnDestroy();

    var valores = {
        "csrfmiddlewaretoken": '{{ csrf_token }}',
        "filtro_codigo": $("#filtro-codigo").val() || '',
        "filtro_estado": $("#filtro-estado").val() || '',
        "filtro_taller": $("#filtro-taller").val() || '',
        "filtro_cliente": $("#filtro-cliente").val() || '',
        "filtro_dominio": $("#filtro-dominio").val() || '',
        "filtro_fecha_desde": $("#filtro-fecha-desde").val() || '',
        "filtro_fecha_hasta": $("#filtro-fecha-hasta").val() || ''
    };

    table = $('#data_table_ajax').DataTable({
        autoWidth: false,
        processing: true,
        searching: true,
        ordering: false,  // Deshabilitar ordenamiento para respetar orden del servidor (por created_at desc)
        dom: 'Bfrtip',
        language: {
            url: "https://cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json"
        },
        buttons: [
            {
                text: '<i class="fa fa-plus"></i> Nuevo Turno',
                className: 'dt-btn-orange',
                action: function(e, dt, node, config) {
                    gestionTurno('');
                }
            }
        ],
        "ajax": {
            "url": "{% url 'gestion_turnos_ajax' %}",
            "data": valores,
            "async": false,
            "type": "POST",
            "dataSrc": "",
            "error": function(xhr, error, code) {
                Swal.fire({
                    title: 'Error!',
                    text: "No se pudo cargar la información. Intente nuevamente.",
                    icon: 'error'
                });
            }
        },
        "columns": [
            {
                "data": "codigo",
                "render": function(data, type, row) {
                    return '<span class="turno-codigo">' + data + '</span>';
                }
            },
            {
                "data": null,
                "render": function(data, type, row) {
                    return data.cliente_nombre + '<br><small class="text-muted">' + data.cliente_dni + '</small>';
                }
            },
            {
                "data": null,
                "render": function(data, type, row) {
                    return '<strong>' + data.vehiculo_dominio + '</strong><br><small class="text-muted">' + data.tipo_vehiculo + '</small>';
                }
            },
            { "data": "taller_nombre" },
            {
                "data": "fecha",
                "render": function(data, type, row) {
                    return convertirFecha(data);
                }
            },
            {
                "data": null,
                "render": function(data, type, row) {
                    return data.hora_inicio + ' - ' + data.hora_fin;
                }
            },
            {
                "data": "estado",
                "render": function(data, type, row) {
                    return getBadgeEstado(data);
                }
            },
            {
                "data": null,
                "sortable": false,
                "width": "18%",
                "className": "text-center",
                "render": function(data, type, row) {
                    var html = '<div class="acciones-container">';

                    // FILA 1: Ver, Editar, Eliminar
                    // Botón Ver
                    html += '<button type="button" class="btn btn-accion btn-ver-turno" title="Ver Turno" value="' + data.id + '"><i class="fa fa-eye"></i></button>';

                    // Botón Editar (solo si no está completado o cancelado)
                    if (data.estado !== 'COMPLETADO' && data.estado !== 'CANCELADO') {
                        html += '<button type="button" class="btn btn-accion btn-editar-turno" title="Editar" value="' + data.id + '"><i class="fa fa-edit"></i></button>';
                    }

                    // Botón Eliminar (solo si está pendiente)
                    if (data.estado === 'PENDIENTE') {
                        html += '<button type="button" class="btn btn-accion btn-eliminar-turno" title="Cancelar Turno" value="' + data.id + '"><i class="fa fa-trash"></i></button>';
                    }

                    // FILA 2: Imprimir, Email, WhatsApp
                    // Botón Imprimir
                    html += '<button type="button" class="btn btn-accion btn-imprimir" title="Imprimir" value="' + data.id + '"><i class="fa fa-print"></i></button>';

                    // Botón Reenviar Email
                    html += '<button type="button" class="btn btn-accion btn-reenviar-email" title="Reenviar Email" value="' + data.id + '"><i class="fa fa-envelope"></i></button>';

                    // Botón Reenviar WhatsApp (desactivado temporalmente)
                    html += '<button type="button" class="btn btn-accion btn-reenviar-whatsapp" title="WhatsApp (próximamente)" value="' + data.id + '" disabled style="opacity: 0.5; cursor: not-allowed;"><i class="fa fa-whatsapp"></i></button>';

                    html += '</div>';
                    return html;
                }
            }
        ],
        order: [[4, 'desc'], [5, 'asc']],
        "rowCallback": function(row, data, index){
            if(data.estado == 'CANCELADO' || data.estado == 'NO_ASISTIO'){
                $(row).addClass('table-secondary');
            } else if(data.estado == 'COMPLETADO'){
                $(row).addClass('table-success');
            }
        }
    });
}

// Función para obtener badge de estado
function getBadgeEstado(estado) {
    var badgeClass = 'badge-pendiente';
    var estadoTexto = estado;

    switch(estado) {
        case 'PENDIENTE':
            badgeClass = 'badge-pendiente';
            estadoTexto = 'Pendiente';
            break;
        case 'CONFIRMADO':
            badgeClass = 'badge-confirmado';
            estadoTexto = 'Confirmado';
            break;
        case 'EN_CURSO':
            badgeClass = 'badge-en-curso';
            estadoTexto = 'En Curso';
            break;
        case 'COMPLETADO':
            badgeClass = 'badge-completado';
            estadoTexto = 'Completado';
            break;
        case 'CANCELADO':
            badgeClass = 'badge-cancelado';
            estadoTexto = 'Cancelado';
            break;
        case 'NO_ASISTIO':
            badgeClass = 'badge-no-asistio';
            estadoTexto = 'No Asistió';
            break;
    }

    return '<span class="badge-estado ' + badgeClass + '">' + estadoTexto + '</span>';
}

// Función para convertir fecha
function convertirFecha(fecha) {
    if (!fecha) return '-';
    var parts = fecha.split('-');
    if (parts.length === 3) {
        return parts[2] + '/' + parts[1] + '/' + parts[0];
    }
    return fecha;
}

// ============================================
// Vista Móvil - Cards
// ============================================
var turnosData = [];
var currentPage = 1;
var itemsPerPage = 5;

function cargarCards() {
    var $container = $('#turnos-cards-container');

    // Mostrar loading
    $container.html('<div class="turnos-cards-loading"><i class="fa fa-spinner fa-spin"></i><p>Cargando turnos...</p></div>');

    var valores = {
        "csrfmiddlewaretoken": '{{ csrf_token }}',
        "filtro_codigo": $("#filtro-codigo").val() || '',
        "filtro_estado": $("#filtro-estado").val() || '',
        "filtro_taller": $("#filtro-taller").val() || '',
        "filtro_cliente": $("#filtro-cliente").val() || '',
        "filtro_dominio": $("#filtro-dominio").val() || '',
        "filtro_fecha_desde": $("#filtro-fecha-desde").val() || '',
        "filtro_fecha_hasta": $("#filtro-fecha-hasta").val() || ''
    };

    $.ajax({
        url: "{% url 'gestion_turnos_ajax' %}",
        type: "POST",
        data: valores,
        success: function(data) {
            turnosData = data;
            currentPage = 1;
            renderCards();
        },
        error: function() {
            $container.html('<div class="turnos-cards-empty"><i class="fa fa-exclamation-triangle"></i><p>Error al cargar los turnos</p></div>');
        }
    });
}

function renderCards() {
    var $container = $('#turnos-cards-container');
    var totalItems = turnosData.length;
    var totalPages = Math.ceil(totalItems / itemsPerPage);
    var startIndex = (currentPage - 1) * itemsPerPage;
    var endIndex = Math.min(startIndex + itemsPerPage, totalItems);
    var pageData = turnosData.slice(startIndex, endIndex);

    // Actualizar contador
    $('#turnos-count').text(totalItems + ' turno' + (totalItems !== 1 ? 's' : ''));

    if (totalItems === 0) {
        $container.html('<div class="turnos-cards-empty"><i class="fa fa-calendar-o"></i><p>No se encontraron turnos</p></div>');
        $('#mobile-pagination').hide();
        return;
    }

    var html = '';
    pageData.forEach(function(turno) {
        html += '<div class="turno-card">';
        html += '  <div class="turno-card-header">';
        html += '    <span class="turno-card-codigo">' + turno.codigo + '</span>';
        html += '    <div class="turno-card-estado">' + getBadgeEstado(turno.estado) + '</div>';
        html += '  </div>';
        html += '  <div class="turno-card-body">';
        html += '    <div class="turno-card-cliente">' + turno.cliente_nombre + '</div>';
        html += '    <div class="turno-card-dni"><i class="fa fa-id-card"></i> ' + turno.cliente_dni + '</div>';
        html += '    <div class="turno-card-info">';
        html += '      <div class="turno-card-info-item">';
        html += '        <span class="label">Vehículo</span>';
        html += '        <span class="value dominio">' + turno.vehiculo_dominio + '</span>';
        html += '      </div>';
        html += '      <div class="turno-card-info-item">';
        html += '        <span class="label">Tipo</span>';
        html += '        <span class="value">' + turno.tipo_vehiculo + '</span>';
        html += '      </div>';
        html += '      <div class="turno-card-info-item">';
        html += '        <span class="label">Fecha</span>';
        html += '        <span class="value">' + convertirFecha(turno.fecha) + '</span>';
        html += '      </div>';
        html += '      <div class="turno-card-info-item">';
        html += '        <span class="label">Horario</span>';
        html += '        <span class="value">' + turno.hora_inicio + ' - ' + turno.hora_fin + '</span>';
        html += '      </div>';
        html += '      <div class="turno-card-info-item">';
        html += '        <span class="label">Taller</span>';
        html += '        <span class="value">' + turno.taller_nombre + '</span>';
        html += '      </div>';
        html += '    </div>';
        html += '  </div>';
        html += '  <div class="turno-card-footer">';
        html += '    <button type="button" class="btn btn-ver" onclick="verTurno(' + turno.id + ')"><i class="fa fa-eye"></i> Ver</button>';
        html += '    <div class="dropdown dropdown-acciones">';
        html += '      <button type="button" class="btn btn-acciones dropdown-toggle" id="dropdownTurno' + turno.id + '" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">';
        html += '        <i class="fa fa-ellipsis-v"></i>';
        html += '      </button>';
        html += '      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownTurno' + turno.id + '">';
        if (turno.estado !== 'COMPLETADO' && turno.estado !== 'CANCELADO') {
            html += '        <a class="dropdown-item" href="javascript:void(0)" onclick="gestionTurno(' + turno.id + ')"><i class="fa fa-edit text-primary"></i> Editar</a>';
        }
        html += '        <a class="dropdown-item" href="javascript:void(0)" onclick="reenviarEmail(' + turno.id + ')"><i class="fa fa-envelope text-info"></i> Enviar Email</a>';
        html += '        <a class="dropdown-item disabled" href="javascript:void(0)" style="opacity: 0.5; pointer-events: none;"><i class="fa fa-whatsapp text-success"></i> WhatsApp (próximamente)</a>';
        html += '        <a class="dropdown-item" href="javascript:void(0)" onclick="imprimirTurno(' + turno.id + ')"><i class="fa fa-print text-secondary"></i> Imprimir</a>';
        if (turno.estado === 'PENDIENTE') {
            html += '        <div class="dropdown-divider"></div>';
            html += '        <a class="dropdown-item" href="javascript:void(0)" onclick="eliminarTurno(' + turno.id + ')"><i class="fa fa-trash text-danger"></i> Cancelar</a>';
        }
        html += '      </div>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
    });

    $container.html(html);

    // Inicializar dropdowns de Bootstrap después de renderizar
    $container.find('.dropdown-toggle').dropdown();

    // Paginación
    if (totalPages > 1) {
        $('#mobile-pagination').show();
        $('#page-info').text(currentPage + ' de ' + totalPages);
        $('#btn-prev-page').prop('disabled', currentPage === 1);
        $('#btn-next-page').prop('disabled', currentPage === totalPages);
    } else {
        $('#mobile-pagination').hide();
    }
}

// Event listeners para paginación móvil
$(document).on('click', '#btn-prev-page', function() {
    if (currentPage > 1) {
        currentPage--;
        renderCards();
        $('html, body').animate({ scrollTop: $('#turnos-cards-container').offset().top - 100 }, 300);
    }
});

$(document).on('click', '#btn-next-page', function() {
    var totalPages = Math.ceil(turnosData.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        renderCards();
        $('html, body').animate({ scrollTop: $('#turnos-cards-container').offset().top - 100 }, 300);
    }
});

// Cargar cards en móvil al inicio
$(document).ready(function() {
    if ($(window).width() <= 768) {
        cargarCards();
    }

    // Recargar al cambiar tamaño de ventana
    $(window).on('resize', function() {
        if ($(window).width() <= 768 && turnosData.length === 0) {
            cargarCards();
        }
    });
});

// Modificar cargarTabla para también actualizar cards
var originalCargarTabla = cargarTabla;
cargarTabla = function() {
    originalCargarTabla();
    if ($(window).width() <= 768) {
        cargarCards();
    }
};

// Event Handlers para botones de acción (tabla desktop)
$('#data_table_ajax').on('click', '.btn-ver-turno', function() {
    var id = $(this).val();
    verTurno(id);
});

$('#data_table_ajax').on('click', '.btn-editar-turno', function() {
    var id = $(this).val();
    gestionTurno(id);
});

$('#data_table_ajax').on('click', '.btn-reenviar-email', function() {
    var id = $(this).val();
    reenviarEmail(id);
});

$('#data_table_ajax').on('click', '.btn-reenviar-whatsapp', function() {
    var id = $(this).val();
    reenviarWhatsapp(id);
});

$('#data_table_ajax').on('click', '.btn-imprimir', function() {
    var id = $(this).val();
    imprimirTurno(id);
});

$('#data_table_ajax').on('click', '.btn-eliminar-turno', function() {
    var id = $(this).val();
    eliminarTurno(id);
});

// Función para ver turno (modal VerMas)
function verTurno(pk) {
    $.ajax({
        url: "{% url 'gestion_turnos_ver' %}",
        type: "POST",
        data: {
            'pk': pk,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        beforeSend: function() {
            Swal.fire({
                title: "Cargando...",
                html: '<i class="fa fa-spinner fa-spin fa-2x"></i>',
                showConfirmButton: false,
                allowOutsideClick: false
            });
        },
        success: function(data) {
            Swal.close();
            $("#modal-lg .modal-content").html(data.html_form);
            $("#modal-lg").modal('show');
        },
        error: function() {
            Swal.fire({
                title: 'Error',
                text: 'No se pudo cargar la información del turno',
                icon: 'error'
            });
        }
    });
}

// Función para gestionar turno (nuevo/editar)
function gestionTurno(pk) {
    // Si es nuevo turno (pk vacío), abrir el turnero en modal con iframe
    if (!pk || pk === '') {
        abrirModalTurnero();
        return;
    }

    // Si es edición, usar el formulario tradicional
    $.ajax({
        url: "{% url 'gestion_turnos_form' %}",
        type: "POST",
        data: {
            'pk': pk,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        beforeSend: function() {
            Swal.fire({
                title: "Cargando...",
                html: '<i class="fa fa-spinner fa-spin fa-2x"></i>',
                showConfirmButton: false,
                allowOutsideClick: false
            });
        },
        success: function(data) {
            Swal.close();
            $("#modal-fullscreen .modal-content").html(data.html_form);
            $("#modal-fullscreen").modal('show');
            cargarSelect2("#modal-fullscreen");
        },
        error: function() {
            Swal.fire({
                title: 'Error',
                text: 'No se pudo cargar el formulario',
                icon: 'error'
            });
        }
    });
}

// Función para abrir el modal con el turnero
function abrirModalTurnero() {
    var turneroUrl = '/turnero/paso1/?embedded=1';
    $('#iframe-turnero').attr('src', turneroUrl);
    $('#modal-turnero').modal('show');
}

// Función para cerrar el modal del turnero
function cerrarModalTurnero() {
    $('#modal-turnero').modal('hide');
    $('#iframe-turnero').attr('src', '');
}

// Listener para mensajes desde el iframe (cuando se guarda el turno)
window.addEventListener('message', function(event) {
    // Verificar que el mensaje viene de nuestro dominio
    if (event.data && event.data.type === 'turno_creado') {
        // Cerrar el modal
        cerrarModalTurnero();

        // Mostrar mensaje de éxito
        Swal.fire({
            title: '¡Turno Creado!',
            text: 'El turno ' + (event.data.codigo || '') + ' fue creado exitosamente',
            icon: 'success',
            timer: 3000,
            showConfirmButton: true,
            confirmButtonText: 'Aceptar'
        });

        // Recargar la tabla
        cargarTabla();
    }
});

// Función para reenviar email
function reenviarEmail(pk) {
    Swal.fire({
        title: '¿Reenviar email de confirmación?',
        text: 'Se enviará nuevamente el email al cliente',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, enviar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "{% url 'gestion_turnos_reenviar_email' %}",
                type: "POST",
                data: {
                    'pk': pk,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.success) {
                        Swal.fire('Enviado!', 'El email fue enviado correctamente', 'success');
                    } else {
                        Swal.fire('Error', data.error || 'No se pudo enviar el email', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Error', 'Error al enviar el email', 'error');
                }
            });
        }
    });
}

// Función para reenviar WhatsApp
function reenviarWhatsapp(pk) {
    $.ajax({
        url: "{% url 'gestion_turnos_whatsapp' %}",
        type: "POST",
        data: {
            'pk': pk,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(data) {
            if (data.success && data.whatsapp_url) {
                window.open(data.whatsapp_url, '_blank');
            } else {
                Swal.fire('Error', data.error || 'No se pudo generar el enlace de WhatsApp', 'error');
            }
        },
        error: function() {
            Swal.fire('Error', 'Error al generar enlace de WhatsApp', 'error');
        }
    });
}

// Función para imprimir turno
function imprimirTurno(pk) {
    window.open("{% url 'gestion_turnos_imprimir' 0 %}".replace("0", pk), '_blank');
}

// Función para eliminar/cancelar turno
function eliminarTurno(pk) {
    Swal.fire({
        title: '¿Cancelar este turno?',
        text: 'Esta acción no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, cancelar turno',
        cancelButtonText: 'No, mantener'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "{% url 'gestion_turnos_cancelar' %}",
                type: "POST",
                data: {
                    'pk': pk,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.success) {
                        Swal.fire('Cancelado!', 'El turno fue cancelado correctamente', 'success');
                        cargarTabla();
                    } else {
                        Swal.fire('Error', data.error || 'No se pudo cancelar el turno', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Error', 'Error al cancelar el turno', 'error');
                }
            });
        }
    });
}

</script>
{% endblock %}
