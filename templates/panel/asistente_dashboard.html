{% extends "panel/base.html" %}
{% block extraCss %}
<style>
    html, body { overflow-x: hidden; max-width: 100%; }

    /* Cards resumen - comunes */
    .stat-card {
        background: #fff; border-radius: 12px; padding: 18px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06); border: 1px solid #eef2f7;
        position: relative; overflow: hidden;
    }
    .stat-card::before {
        content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
        border-radius: 12px 0 0 12px;
    }
    .stat-card-label { font-size: 12px; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
    .stat-card-value { font-size: 28px; font-weight: 700; color: #13304D; margin: 4px 0 2px; }
    .stat-card-desc { font-size: 11px; color: #9ca3af; font-weight: 400; margin: 0; }
    .stat-card-icon { position: absolute; top: 16px; right: 16px; font-size: 24px; opacity: 0.15; color: #13304D; }

    /* Fila principal: 4 KPIs */
    .stat-cards-primary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 16px; }
    .stat-cards-primary .stat-card:nth-child(1)::before { background: linear-gradient(180deg, #003466, #0056b3); }
    .stat-cards-primary .stat-card:nth-child(2)::before { background: linear-gradient(180deg, #0056b3, #2196F3); }
    .stat-cards-primary .stat-card:nth-child(3)::before { background: linear-gradient(180deg, #28a745, #4CAF50); }
    .stat-cards-primary .stat-card:nth-child(4)::before { background: linear-gradient(180deg, #ffc107, #ff9800); }

    /* Fila secundaria: 2 KPIs técnicos */
    .stat-cards-secondary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-cards-secondary .stat-card { background: #f9fbfd; }
    .stat-cards-secondary .stat-card-value { font-size: 22px; }
    .stat-cards-secondary .stat-card-icon { font-size: 20px; }
    .stat-cards-secondary .stat-card:nth-child(1)::before { background: linear-gradient(180deg, #17a2b8, #00bcd4); }
    .stat-cards-secondary .stat-card:nth-child(2)::before { background: linear-gradient(180deg, #6f42c1, #9c27b0); }
    .stat-cards-secondary .stat-card:nth-child(3)::before { background: linear-gradient(180deg, #e67e22, #f39c12); }

    /* Periodo selector - Card contenedora */
    .periodo-card {
        background: #fff; border-radius: 12px; padding: 16px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06); border: 1px solid #eef2f7;
        margin-bottom: 20px;
    }
    .periodo-header {
        display: flex; align-items: center; justify-content: space-between;
        gap: 12px; flex-wrap: wrap;
    }
    .periodo-header-left {
        display: flex; align-items: center; gap: 10px;
    }
    .periodo-icon {
        width: 36px; height: 36px; border-radius: 8px;
        background: linear-gradient(135deg, #003466, #0056b3);
        display: flex; align-items: center; justify-content: center;
        color: #fff; font-size: 14px; flex-shrink: 0;
    }
    .periodo-title {
        font-size: 14px; font-weight: 600; color: #13304D; line-height: 1.2;
    }
    .periodo-subtitle {
        font-size: 11px; color: #9ca3af; font-weight: 400;
    }
    .periodo-controls {
        display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
    }
    .periodo-presets {
        display: flex; gap: 4px; background: #f4f6f9; border-radius: 8px; padding: 3px;
    }
    .periodo-btn {
        padding: 6px 14px; border-radius: 6px; border: none;
        background: transparent; cursor: pointer; font-size: 12px; font-weight: 600;
        color: #6c757d; transition: all 0.2s; white-space: nowrap;
    }
    .periodo-btn:hover { color: #003466; background: rgba(0,52,102,0.06); }
    .periodo-btn.active { background: #003466; color: #fff; box-shadow: 0 2px 6px rgba(0,52,102,0.25); }
    .periodo-divider {
        width: 1px; height: 28px; background: #dee2e6; margin: 0 6px;
    }
    .periodo-custom {
        display: flex; gap: 4px; align-items: center; flex-wrap: wrap;
    }
    .periodo-custom input {
        font-size: 12px; padding: 6px 10px; border-radius: 6px; border: 1px solid #dee2e6;
        max-width: 130px; color: #495057; background: #f9fbfd; transition: border-color 0.2s;
    }
    .periodo-custom input:focus { outline: none; border-color: #003466; background: #fff; }
    .periodo-custom-separator { font-size: 12px; color: #adb5bd; font-weight: 500; }
    .periodo-btn-aplicar {
        padding: 6px 14px; border-radius: 6px; border: 1px solid #003466;
        background: transparent; cursor: pointer; font-size: 12px; font-weight: 600;
        color: #003466; transition: all 0.2s; white-space: nowrap;
    }
    .periodo-btn-aplicar:hover { background: #003466; color: #fff; }
    .periodo-rango-activo {
        display: none; font-size: 11px; color: #003466; font-weight: 500;
        background: #e8f0fe; padding: 3px 10px; border-radius: 12px;
    }
    .periodo-rango-activo.visible { display: inline-flex; align-items: center; gap: 4px; }

    /* Charts grid */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .chart-card {
        background: #fff; border-radius: 12px; padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06); border: 1px solid #eef2f7;
    }
    .chart-card-title { font-size: 14px; font-weight: 600; color: #13304D; margin-bottom: 16px; }
    .chart-card canvas { max-height: 280px; width: 100% !important; }
    .chart-card-full { grid-column: 1 / -1; }

    /* Botón enviar resumen inline */
    .chart-title-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }

    /* Sugerencias ranking */
    .sug-ranking { list-style: none; padding: 0; margin: 0; }
    .sug-ranking-item {
        display: flex; align-items: center; gap: 12px; padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .sug-ranking-item:last-child { border-bottom: none; }
    .sug-ranking-pos { width: 28px; height: 28px; border-radius: 50%; background: #e8f0fe; color: #003466; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0; }
    .sug-ranking-pos.top3 { background: linear-gradient(135deg, #003466, #0056b3); color: #fff; }
    .sug-ranking-tema { flex: 1; font-size: 13px; }
    .sug-ranking-count { font-weight: 700; font-size: 14px; color: #13304D; }
    .sug-ranking-bar { width: 60px; height: 6px; background: #eef2f7; border-radius: 3px; overflow: hidden; }
    .sug-ranking-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, #003466, #0056b3); }

    /* Loading */
    .dashboard-loading { text-align: center; padding: 60px; color: #6c757d; }
    .dashboard-loading i { font-size: 32px; margin-bottom: 12px; }

    @media (max-width: 992px) {
        .stat-cards-primary { grid-template-columns: repeat(2, 1fr); }
        .stat-cards-secondary { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
        .charts-grid { grid-template-columns: 1fr; }
        .stat-cards-primary { grid-template-columns: repeat(2, 1fr); }
        .stat-cards-secondary { grid-template-columns: 1fr; }
        .stat-card-value { font-size: 22px; }
        .stat-card-desc { font-size: 10px; }
        .chart-card { padding: 14px; }
        .chart-card canvas { max-height: 220px; }
        .chart-title-row { flex-direction: column; align-items: flex-start; gap: 8px; }
        .periodo-header { flex-direction: column; align-items: flex-start; }
        .periodo-controls { width: 100%; }
        .periodo-divider { display: none; }
        .periodo-custom { width: 100%; }
        .periodo-custom input { flex: 1; min-width: 0; }
        .sug-ranking-bar { width: 40px; }
        .sug-ranking-item { gap: 8px; }
        .sug-ranking-tema { font-size: 12px; }
    }
    @media (max-width: 480px) {
        .stat-cards-primary { grid-template-columns: 1fr; }
        .stat-cards-secondary { grid-template-columns: 1fr; }
        .stat-card { padding: 14px 16px; }
        .stat-card-value { font-size: 20px; }
        .stat-card-icon { font-size: 20px; top: 12px; right: 12px; }
        .periodo-btn { padding: 5px 10px; font-size: 11px; }
        .periodo-presets { flex-wrap: wrap; }
        .periodo-header-left { display: none; }
        .chart-card-title { font-size: 13px; }
        .sug-ranking-bar { display: none; }
    }
</style>
{% endblock %}

{% block main %}
{% load static %}

<div id="main-content" class="profilepage_2 blog-page">
    <div class="container-fluid">
        <div class="block-header">
            <div class="row g-3">
                <div class="col-lg-5 col-md-8 col-sm-12">
                    <h2><a href="javascript:void(0);" class="btn btn-xs btn-link btn-toggle-fullwidth"><i class="fa fa-arrow-right"></i></a>
                        {{ titulo }}</h2>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'panel_home' %}"><i class="icon-home text-orange"></i></a></li>
                        <li class="breadcrumb-item">Asistente IA</li>
                        <li class="breadcrumb-item active">{{ titulo }}</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row clearfix">
            <div class="col-lg-12 col-md-12">
                <div class="card">
                    <div class="card-body">

                        <!-- Selector de periodo -->
                        <div class="periodo-card">
                            <div class="periodo-header">
                                <div class="periodo-header-left">
                                    <div class="periodo-icon"><i class="fa fa-calendar"></i></div>
                                    <div>
                                        <div class="periodo-title">Periodo de analisis</div>
                                        <div class="periodo-subtitle">Filtra las estadisticas por rango de fechas</div>
                                    </div>
                                </div>
                                <div class="periodo-controls">
                                    <div class="periodo-presets">
                                        <button class="periodo-btn" data-periodo="hoy">Hoy</button>
                                        <button class="periodo-btn" data-periodo="semana">7 dias</button>
                                        <button class="periodo-btn active" data-periodo="mes">30 dias</button>
                                    </div>
                                    <div class="periodo-divider"></div>
                                    <div class="periodo-custom">
                                        <input type="date" id="periodo-desde" title="Fecha desde">
                                        <span class="periodo-custom-separator">a</span>
                                        <input type="date" id="periodo-hasta" title="Fecha hasta">
                                        <button class="periodo-btn-aplicar" data-periodo="custom"><i class="fa fa-search"></i> Aplicar</button>
                                    </div>
                                    <span class="periodo-rango-activo" id="periodo-rango-label"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Cards principales -->
                        <div class="stat-cards-primary">
                            <div class="stat-card">
                                <div class="stat-card-label">Conversaciones</div>
                                <div class="stat-card-value" id="card-conversaciones">-</div>
                                <div class="stat-card-desc">Sesiones de chat iniciadas</div>
                                <i class="fa fa-comments stat-card-icon"></i>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Mensajes</div>
                                <div class="stat-card-value" id="card-mensajes">-</div>
                                <div class="stat-card-desc">Total enviados y recibidos</div>
                                <i class="fa fa-envelope stat-card-icon"></i>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Tasa Resolucion</div>
                                <div class="stat-card-value" id="card-resolucion">-</div>
                                <div class="stat-card-desc">Resueltas por IA sin operador</div>
                                <i class="fa fa-check-circle stat-card-icon"></i>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Derivaciones</div>
                                <div class="stat-card-value" id="card-derivaciones">-</div>
                                <div class="stat-card-desc">Escaladas a operador humano</div>
                                <i class="fa fa-share stat-card-icon"></i>
                            </div>
                        </div>

                        <!-- Cards técnicos -->
                        <div class="stat-cards-secondary">
                            <div class="stat-card">
                                <div class="stat-card-label">Cache Hit Rate</div>
                                <div class="stat-card-value" id="card-cache">-</div>
                                <div class="stat-card-desc">Respuestas desde cache y FAQs</div>
                                <i class="fa fa-database stat-card-icon"></i>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Llamadas IA</div>
                                <div class="stat-card-value" id="card-llamadas-ia">-</div>
                                <div class="stat-card-desc">Consultas enviadas a Gemini</div>
                                <i class="fa fa-bolt stat-card-icon"></i>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Documentos KB</div>
                                <div class="stat-card-value" id="card-docs-kb">-</div>
                                <div class="stat-card-desc">Base de Conocimiento activa</div>
                                <i class="fa fa-book stat-card-icon"></i>
                            </div>
                        </div>

                        <!-- Gráficos -->
                        <div class="charts-grid">
                            <div class="chart-card chart-card-full">
                                <div class="chart-card-title">Conversaciones por dia</div>
                                <canvas id="chart-conv-dia"></canvas>
                            </div>
                            <div class="chart-card">
                                <div class="chart-card-title">Intents mas consultados</div>
                                <canvas id="chart-intents"></canvas>
                            </div>
                            <div class="chart-card">
                                <div class="chart-card-title">Fuente de respuestas</div>
                                <canvas id="chart-sources"></canvas>
                            </div>
                            <div class="chart-card">
                                <div class="chart-card-title">Derivaciones por canal</div>
                                <canvas id="chart-derivaciones"></canvas>
                            </div>
                            <div class="chart-card">
                                <div class="chart-card-title">Horarios pico de consultas</div>
                                <canvas id="chart-horarios"></canvas>
                            </div>
                            <div class="chart-card chart-card-full">
                                <div class="chart-card-title chart-title-row">
                                    <span>Top sugerencias no resueltas</span>
                                    <button class="periodo-btn-aplicar" id="btn-enviar-resumen" title="Envia el resumen semanal de sugerencias por email">
                                        <i class="fa fa-envelope"></i> Enviar resumen ahora
                                    </button>
                                </div>
                                <ul class="sug-ranking" id="sug-ranking">
                                    <li class="dashboard-loading"><i class="fa fa-spinner fa-spin"></i><p>Cargando...</p></li>
                                </ul>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extraJS %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
$(document).ready(function(){
    cargarDashboard('mes');

    $('.periodo-presets .periodo-btn[data-periodo]').on('click', function(){
        var periodo = $(this).data('periodo');
        $('.periodo-presets .periodo-btn').removeClass('active');
        $(this).addClass('active');
        $('#periodo-rango-label').removeClass('visible');
        cargarDashboard(periodo);
    });

    $('.periodo-btn-aplicar[data-periodo="custom"]').on('click', function(){
        var desde = $('#periodo-desde').val();
        var hasta = $('#periodo-hasta').val();
        if (!desde || !hasta) {
            Swal.fire({ title: 'Fechas requeridas', text: 'Selecciona fecha desde y hasta', icon: 'warning', confirmButtonColor: '#003466' });
            return;
        }
        $('.periodo-presets .periodo-btn').removeClass('active');
        var label = desde.split('-').reverse().join('/') + ' - ' + hasta.split('-').reverse().join('/');
        $('#periodo-rango-label').html('<i class="fa fa-calendar-check-o"></i> ' + label).addClass('visible');
        cargarDashboard('custom');
    });

    $('#btn-enviar-resumen').on('click', function(){
        var $btn = $(this);
        Swal.fire({
            title: 'Enviar resumen',
            text: 'Enviar resumen semanal de sugerencias por email?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#003466',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Si, enviar',
            cancelButtonText: 'Cancelar'
        }).then(function(result) {
            if (!result.isConfirmed) return;
            $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Enviando...');
            $.ajax({
                url: "{% url 'asistente_enviar_resumen' %}",
                type: "POST",
                data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
                success: function(res) {
                    $btn.prop('disabled', false).html('<i class="fa fa-envelope"></i> Enviar resumen ahora');
                    Swal.fire({ title: 'Resultado', text: res.message, icon: res.success ? 'success' : 'warning', confirmButtonColor: '#003466' });
                },
                error: function() {
                    $btn.prop('disabled', false).html('<i class="fa fa-envelope"></i> Enviar resumen ahora');
                    Swal.fire({ title: 'Error', text: 'Error al enviar resumen', icon: 'error', confirmButtonColor: '#003466' });
                }
            });
        });
    });
});

var charts = {};

function cargarDashboard(periodo) {
    var datos = {
        csrfmiddlewaretoken: '{{ csrf_token }}',
        periodo: periodo,
        fecha_desde: $('#periodo-desde').val() || '',
        fecha_hasta: $('#periodo-hasta').val() || ''
    };

    $.ajax({
        url: "{% url 'asistente_dashboard_ajax' %}",
        type: "POST",
        data: datos,
        success: function(res) {
            renderCards(res.cards);
            renderChartConvDia(res.chart_conv_dia);
            renderChartIntents(res.chart_intents);
            renderChartSources(res.chart_sources);
            renderChartDerivaciones(res.chart_derivaciones_canal);
            renderChartHorarios(res.chart_horarios);
            renderSugerencias(res.top_sugerencias);
        },
        error: function() {
            Swal.fire({ title: 'Error', text: 'Error al cargar datos del dashboard', icon: 'error', confirmButtonColor: '#003466' });
        }
    });
}

function renderCards(cards) {
    $('#card-conversaciones').text(cards.total_conversaciones);
    $('#card-mensajes').text(cards.total_mensajes);
    $('#card-resolucion').text(cards.tasa_resolucion + '%');
    $('#card-derivaciones').text(cards.total_derivaciones);
    $('#card-cache').text(cards.cache_hit_rate + '%');
    $('#card-llamadas-ia').text(cards.llamadas_ia);
    $('#card-docs-kb').text(cards.docs_kb_activos || 0);
}

function destroyChart(key) {
    if (charts[key]) { charts[key].destroy(); charts[key] = null; }
}

function renderChartConvDia(data) {
    destroyChart('convDia');
    var ctx = document.getElementById('chart-conv-dia').getContext('2d');
    charts['convDia'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Conversaciones',
                data: data.data,
                backgroundColor: 'rgba(0, 52, 102, 0.7)',
                borderColor: '#003466',
                borderWidth: 1,
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
}

function renderChartIntents(data) {
    destroyChart('intents');
    var ctx = document.getElementById('chart-intents').getContext('2d');
    var colors = ['#003466','#0056b3','#2196F3','#42A5F5','#64B5F6','#90CAF9','#BBDEFB','#1976D2','#1565C0','#0D47A1'];
    charts['intents'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: colors.slice(0, data.labels.length),
                borderWidth: 0,
                borderRadius: 4,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
}

function renderChartSources(data) {
    destroyChart('sources');
    var ctx = document.getElementById('chart-sources').getContext('2d');
    var colorMap = {
        'faq': '#28a745', 'cache': '#17a2b8', 'db': '#0056b3',
        'ai': '#6f42c1', 'hardcoded': '#6c757d', 'needs_ai': '#ffc107'
    };
    var labelMap = {
        'faq': 'FAQs', 'cache': 'Cache', 'db': 'Base de datos',
        'ai': 'Gemini IA', 'hardcoded': 'Respuestas fijas', 'needs_ai': 'IA (pendiente)'
    };
    var friendlyLabels = data.labels.map(function(l) { return labelMap[l] || l; });
    charts['sources'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: friendlyLabels,
            datasets: [{
                data: data.data,
                backgroundColor: data.labels.map(function(l) { return colorMap[l] || '#adb5bd'; }),
                borderWidth: 2,
                borderColor: '#fff',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } }
        }
    });
}

function renderChartDerivaciones(data) {
    destroyChart('derivaciones');
    var ctx = document.getElementById('chart-derivaciones').getContext('2d');
    charts['derivaciones'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: ['#25D366', '#0056b3'],
                borderWidth: 2,
                borderColor: '#fff',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } }
        }
    });
}

function renderChartHorarios(data) {
    destroyChart('horarios');
    var ctx = document.getElementById('chart-horarios').getContext('2d');
    charts['horarios'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Consultas',
                data: data.data,
                backgroundColor: function(context) {
                    var v = context.raw;
                    var max = Math.max.apply(null, data.data) || 1;
                    var opacity = 0.3 + (v / max) * 0.7;
                    return 'rgba(0, 52, 102, ' + opacity + ')';
                },
                borderRadius: 3,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
}

function renderSugerencias(data) {
    var container = $('#sug-ranking');
    if (!data || data.length === 0) {
        container.html('<li style="text-align:center; padding:30px; color:#6c757d;">No hay sugerencias pendientes</li>');
        return;
    }
    var maxCount = data[0].veces_detectada || 1;
    var html = '';
    data.forEach(function(s, i) {
        var pct = (s.veces_detectada / maxCount) * 100;
        var topClass = i < 3 ? ' top3' : '';
        html += '<li class="sug-ranking-item">';
        html += '<span class="sug-ranking-pos' + topClass + '">' + (i + 1) + '</span>';
        html += '<span class="sug-ranking-tema">' + s.tema + '</span>';
        html += '<div class="sug-ranking-bar"><div class="sug-ranking-bar-fill" style="width:' + pct + '%;"></div></div>';
        html += '<span class="sug-ranking-count">' + s.veces_detectada + '</span>';
        html += '</li>';
    });
    container.html(html);
}
</script>
{% endblock %}
